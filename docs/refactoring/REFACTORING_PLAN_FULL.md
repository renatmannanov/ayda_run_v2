# –ü–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ Ayda Run v2

**–î–∞—Ç–∞:** 15.12.2025
**–¶–µ–ª—å:** –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∫–æ–¥–æ–≤—É—é –±–∞–∑—É –∫ production –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é
**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** MVP 6/10, –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production 60%

---

## –û–±—â–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è

### –ü—Ä–∏–Ω—Ü–∏–ø—ã —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—Ä–µ–≤—ã—à–µ –≤—Å–µ–≥–æ** - –∫–∞–∂–¥—ã–π —à–∞–≥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—Ä–∞—Ç–∏–º—ã–º
2. **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ—Å—Ç—å** - –º–∞–ª–µ–Ω—å–∫–∏–µ commits, —á–∞—Å—Ç–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
3. **–¢–µ—Å—Ç—ã —Å–Ω–∞—á–∞–ª–∞** - –¥–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç—ã –ø–µ—Ä–µ–¥ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–æ–º
4. **–ù–µ –ª–æ–º–∞–µ–º API** - backward compatibility –¥–ª—è frontend
5. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è** - –æ–±–Ω–æ–≤–ª—è–µ–º docs –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞

### –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

```
Phase 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (2-3 –¥–Ω—è)
   ‚Üì
Phase 2: –°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ Backend (3-4 –¥–Ω—è)
   ‚Üì
Phase 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Frontend (2-3 –¥–Ω—è)
   ‚Üì
Phase 4: Performance –∏ Testing (3-4 –¥–Ω—è)
   ‚Üì
Phase 5: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (1-2 –¥–Ω—è)
```

**–û–±—â–µ–µ –≤—Ä–µ–º—è:** 11-16 –¥–Ω–µ–π (—Å –∑–∞–ø–∞—Å–æ–º)

---

## Phase 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (2-3 –¥–Ω—è)

### –¶–µ–ª—å
–°–æ–∑–¥–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—É—é –±–∞–∑—É –¥–ª—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –∏ —É—Å—Ç—Ä–∞–Ω–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏.

### 1.1 –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (0.5 –¥–Ω—è)

**–ó–∞–¥–∞—á–∏:**

- [ ] –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –≤–µ—Ç–∫—É `refactor/phase-1-security`
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å pre-commit hooks (black, flake8, pylint)
- [ ] –î–æ–±–∞–≤–∏—Ç—å `.editorconfig` –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –∫–æ–¥–∞
- [ ] –°–æ–∑–¥–∞—Ç—å `pytest.ini` –∏ –±–∞–∑–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–µ—Å—Ç–æ–≤

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤:**
```
tests/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ conftest.py              # Fixtures
‚îú‚îÄ‚îÄ test_api/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ test_activities.py
‚îÇ   ‚îú‚îÄ‚îÄ test_clubs.py
‚îÇ   ‚îú‚îÄ‚îÄ test_groups.py
‚îÇ   ‚îî‚îÄ‚îÄ test_auth.py
‚îú‚îÄ‚îÄ test_services/
‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
‚îî‚îÄ‚îÄ test_models/
    ‚îú‚îÄ‚îÄ __init__.py
    ‚îî‚îÄ‚îÄ test_permissions.py
```

**–§–∞–π–ª—ã:**
- `pytest.ini`
- `.editorconfig`
- `.pre-commit-config.yaml`
- `tests/conftest.py` - –±–∞–∑–æ–≤—ã–µ fixtures (test DB, test client)

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** `pytest tests/ -v` –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è

---

### 1.2 –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö security issues (1 –¥–µ–Ω—å)

**–ó–∞–¥–∞—á–∏:**

#### A. –ò—Å–ø—Ä–∞–≤–∏—Ç—å dev mode bypass –≤ auth.py

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# auth.py:90-98
if not x_telegram_init_data:
    from storage.db import SessionLocal, User
    session = SessionLocal()
    # –°–æ–∑–¥–∞–µ—Ç mock user –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```

**–†–µ—à–µ–Ω–∏–µ:**
```python
# auth.py
import logging
logger = logging.getLogger(__name__)

def get_current_user(
    x_telegram_init_data: Optional[str] = Header(None),
    db: Session = Depends(get_db)
) -> User:
    """Get current user from Telegram WebApp initData"""

    if not x_telegram_init_data:
        # ONLY allow dev mode in development environment
        if not settings.debug:
            logger.error("Missing Telegram auth header in production")
            raise HTTPException(
                status_code=401,
                detail="Authentication required"
            )

        logger.warning("‚ö†Ô∏è  Using DEV MODE authentication")
        return get_dev_user(db)

    # ... rest of validation
```

**–¢–µ—Å—Ç—ã:**
- [ ] `test_auth_dev_mode_only_in_debug()`
- [ ] `test_auth_rejects_missing_header_in_prod()`

**–§–∞–π–ª—ã:** `auth.py`

---

#### B. –î–æ–±–∞–≤–∏—Ç—å rate limiting

**–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å:**
```bash
pip install slowapi
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
# api_server.py
from slowapi import Limiter, _rate_limit_exceeded_handler
from slowapi.util import get_remote_address
from slowapi.errors import RateLimitExceeded

limiter = Limiter(key_func=get_remote_address)
app.state.limiter = limiter
app.add_exception_handler(RateLimitExceeded, _rate_limit_exceeded_handler)

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ –∫—Ä–∏—Ç–∏—á–Ω—ã–º endpoints
@app.post("/api/activities")
@limiter.limit("10/minute")  # 10 —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –≤ –º–∏–Ω—É—Ç—É
async def create_activity(...):
    pass

@app.post("/api/clubs")
@limiter.limit("5/minute")
async def create_club(...):
    pass
```

**–§–∞–π–ª—ã:** `api_server.py`, `requirements.txt`

---

#### C. –£–ª—É—á—à–∏—Ç—å CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# api_server.py:29
allow_origins=["*"]  # –ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ!
```

**–†–µ—à–µ–Ω–∏–µ:**
```python
# config.py
class Settings(BaseSettings):
    # ... existing fields
    cors_origins: list[str] = Field(
        default=["http://localhost:5173"],  # Vite dev server
        description="Allowed CORS origins"
    )

    @field_validator('cors_origins')
    @classmethod
    def validate_cors_origins(cls, v: list[str]) -> list[str]:
        if "*" in v and not cls.debug:
            raise ValueError("Wildcard CORS not allowed in production")
        return v

# api_server.py
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins,
    allow_credentials=True,
    allow_methods=["GET", "POST", "PATCH", "DELETE"],
    allow_headers=["*"],
)
```

**Env:**
```bash
# .env
CORS_ORIGINS=["https://your-domain.com","https://t.me"]
```

**–§–∞–π–ª—ã:** `config.py`, `api_server.py`, `.env.example`

---

#### D. –î–æ–±–∞–≤–∏—Ç—å input validation

**–ó–∞–¥–∞—á–∏:**

- [ ] –°–æ–∑–¥–∞—Ç—å Pydantic schemas –¥–ª—è –≤—Å–µ—Ö request/response models
- [ ] –ó–∞–º–µ–Ω–∏—Ç—å Query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞ validated schemas
- [ ] –î–æ–±–∞–≤–∏—Ç—å custom validators –¥–ª—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –ø–æ–ª–µ–π

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```python
# schemas/
schemas/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ activity.py
‚îú‚îÄ‚îÄ club.py
‚îú‚îÄ‚îÄ group.py
‚îî‚îÄ‚îÄ user.py
```

**–ü—Ä–∏–º–µ—Ä:**
```python
# schemas/activity.py
from pydantic import BaseModel, Field, validator
from datetime import datetime
from typing import Optional

class ActivityCreate(BaseModel):
    title: str = Field(..., min_length=3, max_length=200)
    description: Optional[str] = Field(None, max_length=2000)
    date: datetime
    location: str = Field(..., min_length=2, max_length=200)
    sport_type: str = Field(..., regex="^(running|trail|hiking|cycling|other)$")
    difficulty: str = Field(..., regex="^(easy|medium|hard)$")
    distance: Optional[float] = Field(None, ge=0, le=500)  # 0-500km
    duration: Optional[int] = Field(None, ge=1, le=1440)   # 1min-24h
    max_participants: Optional[int] = Field(None, ge=1, le=1000)
    club_id: Optional[int] = None
    group_id: Optional[int] = None

    @validator('date')
    def date_must_be_future(cls, v):
        if v < datetime.now():
            raise ValueError('Activity date must be in the future')
        return v

    @validator('club_id', 'group_id')
    def cannot_have_both_club_and_group(cls, v, values):
        if v and values.get('club_id') and values.get('group_id'):
            raise ValueError('Activity cannot belong to both club and group')
        return v

class ActivityResponse(BaseModel):
    id: int
    title: str
    date: datetime
    # ... all fields
    participants_count: int
    is_joined: bool

    class Config:
        from_attributes = True  # –¥–ª—è ORM models
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
# api_server.py
from schemas.activity import ActivityCreate, ActivityResponse

@app.post("/api/activities", response_model=ActivityResponse)
async def create_activity(
    activity_data: ActivityCreate,  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    # activity_data —É–∂–µ –ø—Ä–æ–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω
    new_activity = Activity(**activity_data.dict(), creator_id=current_user.id)
    # ...
```

**–¢–µ—Å—Ç—ã:**
- [ ] `test_activity_validation_rejects_past_date()`
- [ ] `test_activity_validation_rejects_invalid_sport_type()`
- [ ] `test_activity_validation_max_length()`

**–§–∞–π–ª—ã:** `schemas/*.py`, –æ–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ endpoints

---

#### E. –£–±—Ä–∞—Ç—å debug prints –∏ –¥–æ–±–∞–≤–∏—Ç—å logging

**–ü—Ä–æ–±–ª–µ–º–∞:**
```python
# api_server.py:296, 315, 318
print(f"[DEBUG] ...")
```

**–†–µ—à–µ–Ω–∏–µ:**
```python
# api_server.py (–≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞)
import logging

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ print() –Ω–∞:
logger.info(f"Processing {len(activities)} activities")
logger.debug(f"Activity {activity_id}: club_name='{club_name}'")
```

**–¢–∞–∫–∂–µ –¥–æ–±–∞–≤–∏—Ç—å logging middleware:**
```python
from starlette.middleware.base import BaseHTTPMiddleware
import time

class LoggingMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request, call_next):
        start_time = time.time()

        # Process request
        response = await call_next(request)

        # Log request
        process_time = time.time() - start_time
        logger.info(
            f"{request.method} {request.url.path} "
            f"- {response.status_code} "
            f"- {process_time:.2f}s"
        )

        return response

app.add_middleware(LoggingMiddleware)
```

**–§–∞–π–ª—ã:** `api_server.py`, `groups_clubs_api.py`

---

### 1.3 –°–æ–∑–¥–∞—Ç—å –±–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ (0.5-1 –¥–µ–Ω—å)

**–ó–∞–¥–∞—á–∏:**

- [ ] –¢–µ—Å—Ç—ã –¥–ª—è authentication
- [ ] –¢–µ—Å—Ç—ã –¥–ª—è permissions
- [ ] –¢–µ—Å—Ç—ã –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö CRUD operations

**–ü—Ä–∏–º–µ—Ä:**
```python
# tests/test_api/test_auth.py
import pytest
from fastapi.testclient import TestClient

def test_auth_requires_header_in_production(client, monkeypatch):
    """Test that missing auth header is rejected in production"""
    # Set production mode
    monkeypatch.setenv("DEBUG", "false")

    response = client.get("/api/users/me")
    assert response.status_code == 401
    assert "Authentication required" in response.json()["detail"]

def test_auth_allows_dev_mode_in_debug(client, monkeypatch):
    """Test that dev mode works when DEBUG=true"""
    monkeypatch.setenv("DEBUG", "true")

    response = client.get("/api/users/me")
    assert response.status_code == 200
    assert response.json()["username"] == "admin"

def test_telegram_auth_validation():
    """Test Telegram initData signature validation"""
    # TODO: implement with mock Telegram data
    pass
```

```python
# tests/test_models/test_permissions.py
from permissions import can_manage_club, UserRole

def test_admin_can_manage_any_club(db_session, test_user, test_club):
    """Test that ADMIN role can manage any club"""
    test_user.role = UserRole.ADMIN

    assert can_manage_club(test_user.id, test_club.id) == True

def test_member_cannot_manage_club(db_session, test_user, test_club):
    """Test that MEMBER role cannot manage club"""
    # Create membership with MEMBER role
    membership = Membership(
        user_id=test_user.id,
        club_id=test_club.id,
        role=UserRole.MEMBER
    )
    db_session.add(membership)

    assert can_manage_club(test_user.id, test_club.id) == False
```

**–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ:** 30% (—Ñ–æ–∫—É—Å –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —á–∞—Å—Ç—è—Ö)

**–§–∞–π–ª—ã:** `tests/test_api/*`, `tests/test_models/*`

---

### 1.4 Commit –∏ review Phase 1

**Checklist:**

- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (`pytest tests/ -v`)
- [ ] Security issues –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
- [ ] Logging –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] Rate limiting –¥–æ–±–∞–≤–ª–µ–Ω
- [ ] CORS –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] Input validation —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ù–µ—Ç breaking changes –¥–ª—è frontend

**Git:**
```bash
git add .
git commit -m "feat(security): phase 1 - security hardening and test infrastructure

- Add dev mode env check in auth
- Implement rate limiting (slowapi)
- Fix CORS configuration
- Add Pydantic request/response schemas
- Replace print() with logging
- Add logging middleware
- Create test infrastructure (pytest, fixtures)
- Add basic auth and permissions tests

ü§ñ Generated with Claude Code
Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"

git push origin refactor/phase-1-security
```

**Review checkpoint:** –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏ 1-2 –¥–Ω—è

---

## Phase 2: –°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ Backend (3-4 –¥–Ω—è)

### –¶–µ–ª—å
–†–∞–∑–¥–µ–ª–∏—Ç—å –º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π `api_server.py` –Ω–∞ –º–æ–¥—É–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏.

### 2.1 –°–æ–∑–¥–∞—Ç—å –º–æ–¥—É–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É API (1 –¥–µ–Ω—å)

**–ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```
api/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ dependencies.py      # Shared dependencies (get_db, get_current_user)
‚îú‚îÄ‚îÄ routers/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ activities.py    # Activity endpoints
‚îÇ   ‚îú‚îÄ‚îÄ clubs.py         # Club endpoints
‚îÇ   ‚îú‚îÄ‚îÄ groups.py        # Group endpoints
‚îÇ   ‚îî‚îÄ‚îÄ users.py         # User endpoints
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ activity_service.py
‚îÇ   ‚îú‚îÄ‚îÄ club_service.py
‚îÇ   ‚îú‚îÄ‚îÄ group_service.py
‚îÇ   ‚îî‚îÄ‚îÄ membership_service.py
‚îî‚îÄ‚îÄ utils/
    ‚îú‚îÄ‚îÄ __init__.py
    ‚îî‚îÄ‚îÄ query_helpers.py
```

**–ó–∞–¥–∞—á–∏:**

#### A. –°–æ–∑–¥–∞—Ç—å dependencies.py

```python
# api/dependencies.py
from fastapi import Depends, Header, HTTPException
from sqlalchemy.orm import Session
from typing import Optional
from storage.db import SessionLocal, User
from auth import verify_telegram_webapp_data, get_dev_user
from config import settings
import logging

logger = logging.getLogger(__name__)

def get_db():
    """Database session dependency"""
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

def get_current_user(
    x_telegram_init_data: Optional[str] = Header(None),
    db: Session = Depends(get_db)
) -> User:
    """Get current authenticated user"""
    # Move from auth.py
    # ... (–∫–æ–¥ –∏–∑ auth.py)

def get_current_user_optional(
    x_telegram_init_data: Optional[str] = Header(None),
    db: Session = Depends(get_db)
) -> Optional[User]:
    """Get current user or None"""
    # ... (–∫–æ–¥ –∏–∑ auth.py)
```

**–§–∞–π–ª—ã:** `api/dependencies.py`

---

#### B. –°–æ–∑–¥–∞—Ç—å services layer

**–ò–¥–µ—è:** –í—ã–Ω–µ—Å—Ç–∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –∏–∑ handlers –≤ service functions.

**–ü—Ä–∏–º–µ—Ä:**
```python
# api/services/activity_service.py
from sqlalchemy.orm import Session, joinedload, selectinload
from storage.db import Activity, Participation, User, Club, Group
from schemas.activity import ActivityCreate, ActivityUpdate
from typing import List, Optional
import logging

logger = logging.getLogger(__name__)

class ActivityService:
    """Business logic for activities"""

    @staticmethod
    def get_activities_with_filters(
        db: Session,
        user: Optional[User] = None,
        club_id: Optional[int] = None,
        group_id: Optional[int] = None,
        sport_type: Optional[str] = None,
        date_from: Optional[datetime] = None,
        date_to: Optional[datetime] = None,
        limit: int = 100,
        offset: int = 0
    ) -> List[Activity]:
        """Get activities with filters and eager loading"""

        query = db.query(Activity).options(
            joinedload(Activity.club),
            joinedload(Activity.group),
            joinedload(Activity.creator),
            selectinload(Activity.participations)
        )

        # Apply filters
        if club_id:
            query = query.filter(Activity.club_id == club_id)
        if group_id:
            query = query.filter(Activity.group_id == group_id)
        if sport_type:
            query = query.filter(Activity.sport_type == sport_type)
        if date_from:
            query = query.filter(Activity.date >= date_from)
        if date_to:
            query = query.filter(Activity.date <= date_to)

        # Order and paginate
        query = query.order_by(Activity.date.asc())
        query = query.limit(limit).offset(offset)

        activities = query.all()

        # Enrich with computed fields
        for activity in activities:
            activity.participants_count = len(activity.participations)
            if user:
                activity.is_joined = any(
                    p.user_id == user.id for p in activity.participations
                )
            else:
                activity.is_joined = False

            # Set club/group names
            activity.club_name = activity.club.name if activity.club else None
            activity.group_name = activity.group.name if activity.group else None

        logger.info(f"Fetched {len(activities)} activities with filters")
        return activities

    @staticmethod
    def create_activity(
        db: Session,
        activity_data: ActivityCreate,
        creator: User
    ) -> Activity:
        """Create new activity with permissions check"""

        # Check permissions
        if activity_data.club_id:
            from permissions import can_create_activity_in_club
            if not can_create_activity_in_club(creator.id, activity_data.club_id):
                raise PermissionError("Cannot create activity in this club")

        if activity_data.group_id:
            from permissions import can_create_activity_in_group
            if not can_create_activity_in_group(creator.id, activity_data.group_id):
                raise PermissionError("Cannot create activity in this group")

        # Create activity
        new_activity = Activity(
            **activity_data.dict(),
            creator_id=creator.id
        )
        db.add(new_activity)
        db.commit()
        db.refresh(new_activity)

        logger.info(f"Created activity {new_activity.id} by user {creator.id}")
        return new_activity

    @staticmethod
    def join_activity(
        db: Session,
        activity_id: int,
        user: User
    ) -> dict:
        """Join user to activity"""

        activity = db.query(Activity).get(activity_id)
        if not activity:
            raise ValueError("Activity not found")

        # Check if already joined
        existing = db.query(Participation).filter(
            Participation.activity_id == activity_id,
            Participation.user_id == user.id
        ).first()

        if existing:
            # Leave
            db.delete(existing)
            db.commit()
            logger.info(f"User {user.id} left activity {activity_id}")
            return {"status": "left"}
        else:
            # Join
            # Check max participants
            if activity.max_participants:
                current_count = db.query(Participation).filter(
                    Participation.activity_id == activity_id
                ).count()
                if current_count >= activity.max_participants:
                    raise ValueError("Activity is full")

            participation = Participation(
                activity_id=activity_id,
                user_id=user.id
            )
            db.add(participation)
            db.commit()
            logger.info(f"User {user.id} joined activity {activity_id}")
            return {"status": "joined"}
```

**–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Å–æ–∑–¥–∞—Ç—å:**
- `club_service.py` - –ª–æ–≥–∏–∫–∞ –¥–ª—è –∫–ª—É–±–æ–≤
- `group_service.py` - –ª–æ–≥–∏–∫–∞ –¥–ª—è –≥—Ä—É–ø–ø
- `membership_service.py` - –ª–æ–≥–∏–∫–∞ –¥–ª—è membership

**–§–∞–π–ª—ã:** `api/services/*.py`

---

#### C. –°–æ–∑–¥–∞—Ç—å routers

**–ü—Ä–∏–º–µ—Ä:**
```python
# api/routers/activities.py
from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.orm import Session
from typing import Optional
from datetime import datetime

from api.dependencies import get_db, get_current_user, get_current_user_optional
from api.services.activity_service import ActivityService
from schemas.activity import ActivityCreate, ActivityUpdate, ActivityResponse
from storage.db import User

router = APIRouter(prefix="/api/activities", tags=["activities"])

@router.get("", response_model=list[ActivityResponse])
async def list_activities(
    club_id: Optional[int] = Query(None),
    group_id: Optional[int] = Query(None),
    sport_type: Optional[str] = Query(None),
    date_from: Optional[datetime] = Query(None),
    date_to: Optional[datetime] = Query(None),
    limit: int = Query(100, le=200),
    offset: int = Query(0, ge=0),
    current_user: Optional[User] = Depends(get_current_user_optional),
    db: Session = Depends(get_db)
):
    """List activities with filters"""

    activities = ActivityService.get_activities_with_filters(
        db=db,
        user=current_user,
        club_id=club_id,
        group_id=group_id,
        sport_type=sport_type,
        date_from=date_from,
        date_to=date_to,
        limit=limit,
        offset=offset
    )

    return activities

@router.post("", response_model=ActivityResponse, status_code=201)
async def create_activity(
    activity_data: ActivityCreate,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """Create new activity"""

    try:
        activity = ActivityService.create_activity(db, activity_data, current_user)
        return activity
    except PermissionError as e:
        raise HTTPException(status_code=403, detail=str(e))
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))

@router.post("/{activity_id}/join")
async def join_activity(
    activity_id: int,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """Join or leave activity"""

    try:
        result = ActivityService.join_activity(db, activity_id, current_user)
        return result
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))

# ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ endpoints
```

**–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Å–æ–∑–¥–∞—Ç—å:**
- `clubs.py`
- `groups.py`
- `users.py`

**–§–∞–π–ª—ã:** `api/routers/*.py`

---

#### D. –û–±–Ω–æ–≤–∏—Ç—å api_server.py

```python
# api_server.py (—Å–∏–ª—å–Ω–æ —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π)
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from fastapi.staticfiles import StaticFiles
from slowapi import Limiter
from config import settings
from api.routers import activities, clubs, groups, users
import logging

# Configure logging
logging.basicConfig(
    level=getattr(logging, settings.log_level),
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# Create app
app = FastAPI(
    title="Ayda Run API",
    version="2.0.0",
    docs_url="/api/docs" if settings.debug else None
)

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins,
    allow_credentials=True,
    allow_methods=["GET", "POST", "PATCH", "DELETE"],
    allow_headers=["*"],
)

# Rate limiting
limiter = Limiter(key_func=lambda: "global")  # TODO: use user-based key
app.state.limiter = limiter

# Include routers
app.include_router(activities.router)
app.include_router(clubs.router)
app.include_router(groups.router)
app.include_router(users.router)

# Static files (frontend)
app.mount("/", StaticFiles(directory="webapp/dist", html=True), name="webapp")

# Startup
@app.on_event("startup")
async def startup():
    logger.info("Starting Ayda Run API")
    # Initialize DB tables
    from storage.db import init_db
    init_db()

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
```

**–§–∞–π–ª—ã:** `api_server.py` (–ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å)

---

### 2.2 –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ permissions.py (0.5 –¥–Ω—è)

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ `role_hierarchy`
- –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–π

**–†–µ—à–µ–Ω–∏–µ:**

```python
# permissions.py (refactored)
from enum import Enum
from typing import Optional
from sqlalchemy.orm import Session
from storage.db import User, Club, Group, Membership, UserRole
import logging

logger = logging.getLogger(__name__)

# Constants
ROLE_HIERARCHY = {
    UserRole.MEMBER: 0,
    UserRole.TRAINER: 1,
    UserRole.ORGANIZER: 2,
    UserRole.ADMIN: 3
}

def has_higher_or_equal_role(role1: UserRole, role2: UserRole) -> bool:
    """Check if role1 >= role2 in hierarchy"""
    return ROLE_HIERARCHY[role1] >= ROLE_HIERARCHY[role2]

def get_user_role_in_club(db: Session, user_id: int, club_id: int) -> Optional[UserRole]:
    """Get user's role in club"""
    membership = db.query(Membership).filter(
        Membership.user_id == user_id,
        Membership.club_id == club_id
    ).first()

    return membership.role if membership else None

def get_user_role_in_group(db: Session, user_id: int, group_id: int) -> Optional[UserRole]:
    """Get user's role in group"""
    membership = db.query(Membership).filter(
        Membership.user_id == user_id,
        Membership.group_id == group_id
    ).first()

    return membership.role if membership else None

def can_manage_club(db: Session, user_id: int, club_id: int) -> bool:
    """Check if user can manage club (ORGANIZER+)"""
    role = get_user_role_in_club(db, user_id, club_id)
    if not role:
        return False

    return has_higher_or_equal_role(role, UserRole.ORGANIZER)

def can_create_activity_in_club(db: Session, user_id: int, club_id: int) -> bool:
    """Check if user can create activity in club (ORGANIZER+)"""
    return can_manage_club(db, user_id, club_id)

def can_create_activity_in_group(
    db: Session,
    user_id: int,
    group_id: int
) -> bool:
    """Check if user can create activity in group"""

    group = db.query(Group).get(group_id)
    if not group:
        return False

    # If group belongs to club, need ORGANIZER role in club
    if group.club_id:
        return can_manage_club(db, user_id, group.club_id)

    # Standalone group - need TRAINER role in group
    role = get_user_role_in_group(db, user_id, group_id)
    if not role:
        return False

    return has_higher_or_equal_role(role, UserRole.TRAINER)

# ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –£–±—Ä–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ `SessionLocal()` –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–π
- –ü—Ä–∏–Ω–∏–º–∞—Ç—å `db: Session` –∫–∞–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä
- –í—ã–Ω–µ—Å—Ç–∏ `role_hierarchy` –≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É `ROLE_HIERARCHY`
- –î–æ–±–∞–≤–∏—Ç—å helper —Ñ—É–Ω–∫—Ü–∏–∏
- –î–æ–±–∞–≤–∏—Ç—å logging

**–§–∞–π–ª—ã:** `permissions.py`

---

### 2.3 –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å database queries (1 –¥–µ–Ω—å)

**–ó–∞–¥–∞—á–∏:**

#### A. –î–æ–±–∞–≤–∏—Ç—å eager loading

**–ü—Ä–æ–±–ª–µ–º–∞:** N+1 queries –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –í activity_service.py —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
query = query.options(
    joinedload(Activity.club),
    joinedload(Activity.group),
    selectinload(Activity.participations)
)
```

#### B. –î–æ–±–∞–≤–∏—Ç—å database indexes

```python
# storage/db.py
class Activity(Base):
    __tablename__ = "activities"

    # ... existing fields

    # Add indexes
    __table_args__ = (
        Index('ix_activity_date', 'date'),
        Index('ix_activity_club_id', 'club_id'),
        Index('ix_activity_group_id', 'group_id'),
        Index('ix_activity_sport_type', 'sport_type'),
        Index('ix_activity_creator_id', 'creator_id'),
    )

class Participation(Base):
    __tablename__ = "participations"

    # ... existing fields

    __table_args__ = (
        Index('ix_participation_activity_user', 'activity_id', 'user_id'),
        Index('ix_participation_user_id', 'user_id'),
    )

class Membership(Base):
    __tablename__ = "memberships"

    # ... existing fields

    __table_args__ = (
        Index('ix_membership_user_club', 'user_id', 'club_id'),
        Index('ix_membership_user_group', 'user_id', 'group_id'),
    )
```

**Migration:**
```bash
alembic revision --autogenerate -m "add_database_indexes"
alembic upgrade head
```

**–§–∞–π–ª—ã:** `storage/db.py`, –Ω–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

#### C. –î–æ–±–∞–≤–∏—Ç—å pagination helpers

```python
# api/utils/query_helpers.py
from sqlalchemy.orm import Query
from typing import TypeVar, Generic, List
from pydantic import BaseModel

T = TypeVar('T')

class PaginatedResponse(BaseModel, Generic[T]):
    items: List[T]
    total: int
    limit: int
    offset: int
    has_more: bool

def paginate_query(
    query: Query,
    limit: int = 50,
    offset: int = 0
) -> PaginatedResponse:
    """Paginate SQLAlchemy query"""

    total = query.count()
    items = query.limit(limit).offset(offset).all()
    has_more = (offset + limit) < total

    return PaginatedResponse(
        items=items,
        total=total,
        limit=limit,
        offset=offset,
        has_more=has_more
    )
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
# –í routers
@router.get("", response_model=PaginatedResponse[ActivityResponse])
async def list_activities(...):
    query = ActivityService.build_query(db, filters)
    return paginate_query(query, limit, offset)
```

**–§–∞–π–ª—ã:** `api/utils/query_helpers.py`

---

### 2.4 –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–π—Å—è –∫–æ–¥ –≤ groups_clubs_api.py (0.5 –¥–Ω—è)

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è:** –°–æ–∑–¥–∞—Ç—å generic CRUD service

```python
# api/services/base_service.py
from typing import TypeVar, Generic, Type, List, Optional
from sqlalchemy.orm import Session
from pydantic import BaseModel

ModelType = TypeVar("ModelType")
CreateSchemaType = TypeVar("CreateSchemaType", bound=BaseModel)
UpdateSchemaType = TypeVar("UpdateSchemaType", bound=BaseModel)

class CRUDService(Generic[ModelType, CreateSchemaType, UpdateSchemaType]):
    """Generic CRUD operations"""

    def __init__(self, model: Type[ModelType]):
        self.model = model

    def get(self, db: Session, id: int) -> Optional[ModelType]:
        return db.query(self.model).get(id)

    def get_multi(
        self,
        db: Session,
        skip: int = 0,
        limit: int = 100
    ) -> List[ModelType]:
        return db.query(self.model).offset(skip).limit(limit).all()

    def create(
        self,
        db: Session,
        obj_in: CreateSchemaType,
        **kwargs
    ) -> ModelType:
        obj_data = obj_in.dict()
        obj_data.update(kwargs)
        db_obj = self.model(**obj_data)
        db.add(db_obj)
        db.commit()
        db.refresh(db_obj)
        return db_obj

    def update(
        self,
        db: Session,
        db_obj: ModelType,
        obj_in: UpdateSchemaType
    ) -> ModelType:
        obj_data = obj_in.dict(exclude_unset=True)
        for field, value in obj_data.items():
            setattr(db_obj, field, value)
        db.commit()
        db.refresh(db_obj)
        return db_obj

    def delete(self, db: Session, id: int) -> None:
        obj = db.query(self.model).get(id)
        db.delete(obj)
        db.commit()
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
# api/services/club_service.py
from api.services.base_service import CRUDService
from storage.db import Club
from schemas.club import ClubCreate, ClubUpdate

class ClubService(CRUDService[Club, ClubCreate, ClubUpdate]):
    def __init__(self):
        super().__init__(Club)

    # Add club-specific methods
    def get_club_members(self, db: Session, club_id: int):
        # ...
        pass
```

**–§–∞–π–ª—ã:** `api/services/base_service.py`, —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å `club_service.py`, `group_service.py`

---

### 2.5 –¢–µ—Å—Ç—ã –¥–ª—è Phase 2 (0.5-1 –¥–µ–Ω—å)

**–ó–∞–¥–∞—á–∏:**

- [ ] –¢–µ—Å—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ service
- [ ] –¢–µ—Å—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ router
- [ ] Integration tests –¥–ª—è –ø–æ–ª–Ω—ã—Ö flows

**–ü—Ä–∏–º–µ—Ä:**
```python
# tests/test_services/test_activity_service.py
import pytest
from datetime import datetime, timedelta
from api.services.activity_service import ActivityService
from schemas.activity import ActivityCreate

def test_create_activity(db_session, test_user):
    """Test activity creation"""

    activity_data = ActivityCreate(
        title="Morning Run",
        description="Easy 5k",
        date=datetime.now() + timedelta(days=1),
        location="Central Park",
        sport_type="running",
        difficulty="easy",
        distance=5.0
    )

    activity = ActivityService.create_activity(
        db=db_session,
        activity_data=activity_data,
        creator=test_user
    )

    assert activity.id is not None
    assert activity.title == "Morning Run"
    assert activity.creator_id == test_user.id

def test_join_activity_success(db_session, test_activity, test_user):
    """Test joining activity"""

    result = ActivityService.join_activity(
        db=db_session,
        activity_id=test_activity.id,
        user=test_user
    )

    assert result["status"] == "joined"

    # Verify in DB
    from storage.db import Participation
    participation = db_session.query(Participation).filter(
        Participation.activity_id == test_activity.id,
        Participation.user_id == test_user.id
    ).first()

    assert participation is not None

def test_join_full_activity_fails(db_session, test_activity, test_user):
    """Test joining full activity fails"""

    test_activity.max_participants = 1
    # Join first user
    ActivityService.join_activity(db_session, test_activity.id, test_user)

    # Try to join second user
    from storage.db import User
    user2 = User(telegram_id=999, username="user2")
    db_session.add(user2)
    db_session.commit()

    with pytest.raises(ValueError, match="Activity is full"):
        ActivityService.join_activity(db_session, test_activity.id, user2)
```

**–§–∞–π–ª—ã:** `tests/test_services/*`, `tests/test_api/*`

---

### 2.6 Commit –∏ review Phase 2

**Checklist:**

- [ ] –ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ API —Å–æ–∑–¥–∞–Ω–∞
- [ ] Services layer —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Routers —Ä–∞–∑–¥–µ–ª–µ–Ω—ã –ø–æ —Ä–µ—Å—É—Ä—Å–∞–º
- [ ] –ù–µ—Ç –¥—É–±–ª–∏—Ä—É—é—â–µ–≥–æ—Å—è –∫–æ–¥–∞
- [ ] Database queries –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- [ ] Indexes –¥–æ–±–∞–≤–ª–µ–Ω—ã
- [ ] –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (coverage 40%+)
- [ ] API –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º —Å frontend

**Git:**
```bash
git add .
git commit -m "refactor(backend): phase 2 - modular architecture

- Split api_server.py into routers and services
- Create service layer for business logic
- Refactor permissions.py (remove session creation)
- Add database indexes for performance
- Implement generic CRUD service
- Add pagination helpers
- Remove duplicate code in groups_clubs_api
- Add service and router tests

ü§ñ Generated with Claude Code
Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"

git push origin refactor/phase-2-backend
```

---

## Phase 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Frontend (2-3 –¥–Ω—è)

### –¶–µ–ª—å
–£–ø—Ä–æ—Å—Ç–∏—Ç—å —Å–ª–æ–∂–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã, —É–ª—É—á—à–∏—Ç—å –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞, –¥–æ–±–∞–≤–∏—Ç—å React Query.

### 3.1 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è TanStack Query (React Query) (1 –¥–µ–Ω—å)

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞:**
```bash
cd webapp
npm install @tanstack/react-query
npm install @tanstack/react-query-devtools
```

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**
```jsx
// webapp/src/main.jsx
import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
import { ReactQueryDevtools } from '@tanstack/react-query-devtools'

const queryClient = new QueryClient({
    defaultOptions: {
        queries: {
            staleTime: 1000 * 60 * 5,  // 5 minutes
            cacheTime: 1000 * 60 * 30, // 30 minutes
            retry: 1,
            refetchOnWindowFocus: false,
        },
    },
})

ReactDOM.createRoot(document.getElementById('root')).render(
    <React.StrictMode>
        <QueryClientProvider client={queryClient}>
            <App />
            <ReactQueryDevtools initialIsOpen={false} />
        </QueryClientProvider>
    </React.StrictMode>
)
```

**–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ hooks:**
```javascript
// webapp/src/hooks/useActivities.js (–Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —Å React Query)
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import { activitiesApi } from '../api'

export function useActivities(filters = {}) {
    return useQuery({
        queryKey: ['activities', filters],
        queryFn: () => activitiesApi.list(filters),
    })
}

export function useActivity(id) {
    return useQuery({
        queryKey: ['activity', id],
        queryFn: () => activitiesApi.get(id),
        enabled: !!id,
    })
}

export function useJoinActivity() {
    const queryClient = useQueryClient()

    return useMutation({
        mutationFn: (activityId) => activitiesApi.join(activityId),
        onSuccess: (data, activityId) => {
            // Invalidate activities list
            queryClient.invalidateQueries({ queryKey: ['activities'] })
            // Update specific activity
            queryClient.invalidateQueries({ queryKey: ['activity', activityId] })
        },
    })
}

export function useCreateActivity() {
    const queryClient = useQueryClient()

    return useMutation({
        mutationFn: (data) => activitiesApi.create(data),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['activities'] })
        },
    })
}

// ... –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
```

**–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
```jsx
// webapp/src/screens/Home.jsx (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
import { useActivities } from '../hooks/useActivities'
import { useJoinActivity } from '../hooks/useActivities'

export default function Home() {
    const [mode, setMode] = useState('all')
    const [currentWeekIndex, setCurrentWeekIndex] = useState(null)

    // React Query –≤–º–µ—Å—Ç–æ useApi
    const { data: activities = [], isLoading, error } = useActivities()
    const joinActivity = useJoinActivity()

    const handleJoinToggle = (activityId) => {
        joinActivity.mutate(activityId)
    }

    // ... rest of component

    if (isLoading) return <Loading />
    if (error) return <ErrorMessage error={error} />

    // ... render
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π cache
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π refetch
- ‚úÖ Optimistic updates
- ‚úÖ DevTools –¥–ª—è debugging
- ‚úÖ –ú–µ–Ω—å—à–µ boilerplate –∫–æ–¥–∞

**–§–∞–π–ª—ã:** –æ–±–Ω–æ–≤–∏—Ç—å `hooks/*`, –≤—Å–µ screens

---

### 3.2 –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ Home.jsx (1 –¥–µ–Ω—å)

**–¢–µ–∫—É—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- 342 —Å—Ç—Ä–æ–∫–∏
- 5+ useState
- –ë–æ–ª—å—à–∏–µ inline –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

**–†–µ—à–µ–Ω–∏–µ:**

#### A. –í—ã–Ω–µ—Å—Ç–∏ DaySection –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç

```jsx
// webapp/src/components/DaySection.jsx
import React from 'react'
import { ActivityCard } from './ActivityCard'
import { dayNames } from '../data/sample_data'

export function DaySection({
    weekNumber,
    dayOfWeek,
    activities,
    expandedDays,
    onToggleExpand,
    onJoinToggle
}) {
    const hasActivities = activities && activities.length > 0
    const now = new Date()
    const isTodayDay = new Date().getDay() === dayOfWeek

    // –õ–æ–≥–∏–∫–∞ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è
    const isCurrentWeek = weekNumber === 0
    const isPastWeek = weekNumber < 0
    const currentDayOfWeek = now.getDay()

    const dayOrder = dayOfWeek === 0 ? 7 : dayOfWeek
    const currentDayOrder = currentDayOfWeek === 0 ? 7 : currentDayOfWeek

    const isPastDay = isPastWeek || (isCurrentWeek && dayOrder < currentDayOrder)
    const expandKey = `${weekNumber}-${dayOfWeek}`
    const isExpanded = expandedDays[expandKey] || false

    const activityCount = hasActivities ? activities.length : 0

    return (
        <div className="mb-4">
            {/* Day Header */}
            <div className="flex items-center gap-2 mb-3">
                {isPastDay ? (
                    <button
                        onClick={() => onToggleExpand(weekNumber, dayOfWeek)}
                        className="flex items-center gap-2 text-sm text-gray-400 hover:text-gray-600"
                    >
                        <span>{dayNames[dayOfWeek]}</span>
                        <span className={`text-xs transition-transform ${isExpanded ? 'rotate-180' : ''}`}>
                            ‚ñæ
                        </span>
                    </button>
                ) : (
                    <span className={`text-sm font-medium ${isTodayDay ? 'text-gray-800' : 'text-gray-500'}`}>
                        {isTodayDay ? `–°–µ–≥–æ–¥–Ω—è, ${dayNames[dayOfWeek].toLowerCase()}` : dayNames[dayOfWeek]}
                    </span>
                )}
                <div className="flex-1 border-b border-gray-200" />
                <span className="text-xs text-gray-400">{activityCount}</span>
            </div>

            {/* Activities */}
            {isPastDay ? (
                isExpanded && <ActivityList activities={activities} onJoinToggle={onJoinToggle} />
            ) : (
                <ActivityList activities={activities} onJoinToggle={onJoinToggle} />
            )}
        </div>
    )
}

function ActivityList({ activities, onJoinToggle }) {
    const now = new Date()

    if (!activities || activities.length === 0) {
        return <p className="text-sm text-gray-300 mb-3 pl-1">–í —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π</p>
    }

    return (
        <div className="space-y-3">
            {activities.map(activity => {
                const isPast = new Date(activity.date) < now
                return (
                    <div key={activity.id} className={isPast ? 'opacity-50' : ''}>
                        <ActivityCard
                            activity={activity}
                            onJoinToggle={onJoinToggle}
                        />
                    </div>
                )
            })}
        </div>
    )
}
```

**–§–∞–π–ª—ã:** `webapp/src/components/DaySection.jsx`

#### B. –°–æ–∑–¥–∞—Ç—å custom hook –¥–ª—è week navigation

```javascript
// webapp/src/hooks/useWeekNavigation.js
import { useState, useEffect, useCallback } from 'react'
import { getWeekNumber, getWeekStart, getWeekEnd } from '../data/sample_data'

export function useWeekNavigation(activities, mode) {
    const [currentWeekIndex, setCurrentWeekIndex] = useState(null)

    // Group activities by week and day
    const allWeeks = useCallback(() => {
        if (!activities) return []

        // Filter based on mode
        let filtered = activities
        if (mode === 'my') {
            filtered = activities.filter(a => a.isJoined)
        }

        // Group by week
        const weekMap = {}
        const today = new Date()

        filtered.forEach(activity => {
            const activityDate = new Date(activity.date)
            const weekNum = getWeekNumber(activityDate, today)

            if (!weekMap[weekNum]) {
                weekMap[weekNum] = {
                    weekNumber: weekNum,
                    weekStart: getWeekStart(activityDate),
                    weekEnd: getWeekEnd(activityDate),
                    days: {}
                }
            }

            const dayOfWeek = activityDate.getDay()
            if (!weekMap[weekNum].days[dayOfWeek]) {
                weekMap[weekNum].days[dayOfWeek] = []
            }

            weekMap[weekNum].days[dayOfWeek].push(activity)
        })

        // Sort activities within each day
        Object.values(weekMap).forEach(week => {
            Object.values(week.days).forEach(dayActivities => {
                dayActivities.sort((a, b) => new Date(a.date) - new Date(b.date))
            })
        })

        // Convert to array and sort
        return Object.values(weekMap).sort((a, b) => a.weekNumber - b.weekNumber)
    }, [activities, mode])()

    // Set initial week to current week
    useEffect(() => {
        if (currentWeekIndex === null && allWeeks.length > 0) {
            const currentWeekIdx = allWeeks.findIndex(w => w.weekNumber === 0)
            setCurrentWeekIndex(currentWeekIdx >= 0 ? currentWeekIdx : 0)
        }
    }, [allWeeks, currentWeekIndex])

    const displayedWeek = currentWeekIndex !== null && allWeeks[currentWeekIndex]
        ? allWeeks[currentWeekIndex]
        : null

    const goToPreviousWeek = () => {
        if (currentWeekIndex > 0) {
            setCurrentWeekIndex(currentWeekIndex - 1)
        }
    }

    const goToNextWeek = () => {
        if (currentWeekIndex < allWeeks.length - 1) {
            setCurrentWeekIndex(currentWeekIndex + 1)
        }
    }

    const canGoPrevious = currentWeekIndex > 0
    const canGoNext = currentWeekIndex < allWeeks.length - 1

    return {
        displayedWeek,
        goToPreviousWeek,
        goToNextWeek,
        canGoPrevious,
        canGoNext
    }
}
```

**–§–∞–π–ª—ã:** `webapp/src/hooks/useWeekNavigation.js`

#### C. –£–ø—Ä–æ—Å—Ç–∏—Ç—å Home.jsx

```jsx
// webapp/src/screens/Home.jsx (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è - ~150 —Å—Ç—Ä–æ–∫)
import React, { useState } from 'react'
import { useActivities, useJoinActivity } from '../hooks/useActivities'
import { useWeekNavigation } from '../hooks/useWeekNavigation'
import { DaySection } from '../components/DaySection'
import { BottomNav, CreateMenu, Loading, ErrorMessage, EmptyState } from '../components'

export default function Home() {
    const [mode, setMode] = useState('all') // 'my' | 'all'
    const [showCreateMenu, setShowCreateMenu] = useState(false)
    const [expandedDays, setExpandedDays] = useState({})

    // Fetch data with React Query
    const { data: activities = [], isLoading, error } = useActivities()
    const joinActivity = useJoinActivity()

    // Week navigation logic
    const {
        displayedWeek,
        goToPreviousWeek,
        goToNextWeek,
        canGoPrevious,
        canGoNext
    } = useWeekNavigation(activities, mode)

    // Handlers
    const handleJoinToggle = (activityId) => {
        joinActivity.mutate(activityId)
    }

    const toggleDayExpansion = (weekNum, dayOfWeek) => {
        const key = `${weekNum}-${dayOfWeek}`
        setExpandedDays(prev => ({
            ...prev,
            [key]: !prev[key]
        }))
    }

    // Calculate totals
    const totalCount = displayedWeek
        ? Object.values(displayedWeek.days).reduce((sum, dayActivities) =>
            sum + dayActivities.length, 0)
        : 0

    const hasActivities = totalCount > 0

    // Format week range
    const getWeekRangeText = (week) => {
        if (!week) return ''
        const start = week.weekStart
        const end = week.weekEnd
        const formatDay = (date) => date.toLocaleDateString('ru-RU', {
            day: 'numeric', month: 'short'
        })
        return `${formatDay(start)} - ${formatDay(end)}`
    }

    if (isLoading) return <Loading text="–ó–∞–≥—Ä—É–∂–∞–µ–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏..." />
    if (error) return <ErrorMessage message={error.message} />

    return (
        <div className="min-h-screen bg-gray-50 flex flex-col pb-20">
            {/* Header */}
            <div className="bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between sticky top-0 z-10">
                <Toggle mode={mode} setMode={setMode} />
                <span className="text-sm text-gray-400">{totalCount}</span>
            </div>

            {/* Week Navigation */}
            {displayedWeek && (
                <WeekNavigationBar
                    week={displayedWeek}
                    onPrevious={goToPreviousWeek}
                    onNext={goToNextWeek}
                    canGoPrevious={canGoPrevious}
                    canGoNext={canGoNext}
                    getWeekRangeText={getWeekRangeText}
                />
            )}

            {/* Content */}
            <div className="flex-1 overflow-auto px-4 py-4">
                {hasActivities && displayedWeek ? (
                    <div className="mb-6">
                        {[1, 2, 3, 4, 5, 6, 0].map(dayOfWeek => (
                            <DaySection
                                key={`${displayedWeek.weekNumber}-${dayOfWeek}`}
                                weekNumber={displayedWeek.weekNumber}
                                dayOfWeek={dayOfWeek}
                                activities={displayedWeek.days[dayOfWeek]}
                                expandedDays={expandedDays}
                                onToggleExpand={toggleDayExpansion}
                                onJoinToggle={handleJoinToggle}
                            />
                        ))}
                    </div>
                ) : (
                    <EmptyState
                        icon="üìÖ"
                        title="–ü–æ–∫–∞ –ø—É—Å—Ç–æ"
                        description="–ù–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫"
                        actionText={mode === 'my' ? "–°–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ" : null}
                        onAction={() => setMode('all')}
                    />
                )}
            </div>

            {/* Bottom Navigation */}
            <div className="fixed bottom-0 left-0 right-0 max-w-md mx-auto">
                <BottomNav onCreateClick={() => setShowCreateMenu(true)} />
            </div>

            {/* Create Menu */}
            <CreateMenu
                isOpen={showCreateMenu}
                onClose={() => setShowCreateMenu(false)}
            />
        </div>
    )
}

// Helper components
function Toggle({ mode, setMode }) {
    return (
        <div className="flex items-center gap-1 text-sm">
            <button
                onClick={() => setMode('my')}
                className={`transition-colors ${mode === 'my'
                    ? 'text-gray-900 font-medium'
                    : 'text-gray-400 hover:text-gray-600'
                }`}
            >
                –ú–æ–∏
            </button>
            <span className="text-gray-300">/</span>
            <button
                onClick={() => setMode('all')}
                className={`transition-colors ${mode === 'all'
                    ? 'text-gray-900 font-medium'
                    : 'text-gray-400 hover:text-gray-600'
                }`}
            >
                –í—Å–µ
            </button>
        </div>
    )
}

function WeekNavigationBar({ week, onPrevious, onNext, canGoPrevious, canGoNext, getWeekRangeText }) {
    return (
        <div className="bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between sticky top-[52px] z-10">
            <button
                onClick={onPrevious}
                disabled={!canGoPrevious}
                className={`text-2xl ${canGoPrevious ? 'text-gray-700 hover:text-gray-900' : 'text-gray-300'}`}
            >
                ‚Äπ
            </button>
            <div className="text-center">
                <div className="text-sm font-medium text-gray-900">
                    {week.weekNumber === 0 ? '–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è' :
                        week.weekNumber > 0 ? `+${week.weekNumber} –Ω–µ–¥–µ–ª—è` :
                            `${week.weekNumber} –Ω–µ–¥–µ–ª—è`}
                </div>
                <div className="text-xs text-gray-500">
                    {getWeekRangeText(week)}
                </div>
            </div>
            <button
                onClick={onNext}
                disabled={!canGoNext}
                className={`text-2xl ${canGoNext ? 'text-gray-700 hover:text-gray-900' : 'text-gray-300'}`}
            >
                ‚Ä∫
            </button>
        </div>
    )
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –°–æ–∫—Ä–∞—â–µ–Ω–æ —Å 342 –¥–æ ~150 —Å—Ç—Ä–æ–∫
- ‚úÖ –í—ã–Ω–µ—Å–µ–Ω—ã 3 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ (DaySection, Toggle, WeekNavigationBar)
- ‚úÖ –°–æ–∑–¥–∞–Ω custom hook useWeekNavigation
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ —á–∏—Ç–∞–µ–º–æ—Å—Ç—å

**–§–∞–π–ª—ã:** `webapp/src/screens/Home.jsx` (refactored)

---

### 3.3 –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (0.5-1 –¥–µ–Ω—å)

**–ó–∞–¥–∞—á–∏:**

#### A. Shared DetailPage component

```jsx
// webapp/src/components/DetailPage.jsx
import React from 'react'
import { useNavigate } from 'react-router-dom'
import { Loading, ErrorMessage, Button } from './ui'

export function DetailPage({
    title,
    subtitle,
    loading,
    error,
    headerActions,
    children,
    backButton = true
}) {
    const navigate = useNavigate()

    if (loading) return <Loading />
    if (error) return <ErrorMessage message={error.message} />

    return (
        <div className="min-h-screen bg-gray-50">
            {/* Header */}
            <div className="bg-white border-b border-gray-200 px-4 py-3 sticky top-0 z-10">
                <div className="flex items-center justify-between">
                    {backButton && (
                        <button
                            onClick={() => navigate(-1)}
                            className="text-gray-700 hover:text-gray-900"
                        >
                            ‚Üê –ù–∞–∑–∞–¥
                        </button>
                    )}
                    <div className="flex gap-2">
                        {headerActions}
                    </div>
                </div>
                {title && (
                    <div className="mt-3">
                        <h1 className="text-lg font-semibold text-gray-900">{title}</h1>
                        {subtitle && <p className="text-sm text-gray-500">{subtitle}</p>}
                    </div>
                )}
            </div>

            {/* Content */}
            <div className="px-4 py-4">
                {children}
            </div>
        </div>
    )
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```jsx
// ActivityDetail.jsx (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
export default function ActivityDetail() {
    const { id } = useParams()
    const { data: activity, isLoading, error } = useActivity(id)

    return (
        <DetailPage
            title={activity?.title}
            subtitle={formatDate(activity?.date)}
            loading={isLoading}
            error={error}
            headerActions={
                <>
                    <Button onClick={handleEdit}>–ò–∑–º–µ–Ω–∏—Ç—å</Button>
                    <Button onClick={handleDelete} variant="danger">–£–¥–∞–ª–∏—Ç—å</Button>
                </>
            }
        >
            {/* Activity content */}
            <ActivityInfo activity={activity} />
            <ParticipantsList activityId={id} />
        </DetailPage>
    )
}
```

**–§–∞–π–ª—ã:** `webapp/src/components/DetailPage.jsx`

#### B. Shared ParticipantsList component

```jsx
// webapp/src/components/ParticipantsList.jsx
import React, { useState } from 'react'
import { useActivityParticipants } from '../hooks/useActivities'

export function ParticipantsList({ activityId, limit = 5 }) {
    const [showAll, setShowAll] = useState(false)
    const { data: participants = [], isLoading } = useActivityParticipants(activityId)

    if (isLoading) return <div>–ó–∞–≥—Ä—É–∑–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤...</div>
    if (participants.length === 0) return <div>–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>

    const displayedParticipants = showAll ? participants : participants.slice(0, limit)

    return (
        <div className="bg-white rounded-xl border border-gray-200 p-4">
            <div className="flex items-center justify-between mb-3">
                <h3 className="font-medium text-gray-900">
                    –£—á–∞—Å—Ç–Ω–∏–∫–∏ ({participants.length})
                </h3>
            </div>

            <div className="space-y-2">
                {displayedParticipants.map(participant => (
                    <div key={participant.id} className="flex items-center gap-3">
                        <div className="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center">
                            {participant.first_name?.[0] || '?'}
                        </div>
                        <div>
                            <div className="text-sm font-medium text-gray-900">
                                {participant.first_name || participant.username}
                            </div>
                            <div className="text-xs text-gray-500">
                                @{participant.username}
                            </div>
                        </div>
                    </div>
                ))}
            </div>

            {participants.length > limit && !showAll && (
                <button
                    onClick={() => setShowAll(true)}
                    className="mt-3 text-sm text-gray-600 hover:text-gray-900"
                >
                    –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ—Ö ({participants.length})
                </button>
            )}
        </div>
    )
}
```

**–§–∞–π–ª—ã:** `webapp/src/components/ParticipantsList.jsx`

---

### 3.4 –î–æ–±–∞–≤–∏—Ç—å form validation (0.5 –¥–Ω—è)

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞:**
```bash
npm install react-hook-form zod @hookform/resolvers
```

**–°–æ–∑–¥–∞—Ç—å validation schemas:**
```javascript
// webapp/src/validation/activitySchema.js
import { z } from 'zod'

export const activitySchema = z.object({
    title: z.string()
        .min(3, '–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤')
        .max(200, '–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ'),
    description: z.string()
        .max(2000, '–û–ø–∏—Å–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ')
        .optional(),
    date: z.date({
        required_error: '–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É',
    }),
    location: z.string()
        .min(2, '–£–∫–∞–∂–∏—Ç–µ –º–µ—Å—Ç–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è'),
    sportType: z.enum(['running', 'trail', 'hiking', 'cycling', 'other'], {
        required_error: '–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ —Å–ø–æ—Ä—Ç–∞',
    }),
    difficulty: z.enum(['easy', 'medium', 'hard'], {
        required_error: '–í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–æ–∂–Ω–æ—Å—Ç—å',
    }),
    distance: z.number()
        .min(0, '–î–∏—Å—Ç–∞–Ω—Ü–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π')
        .max(500, '–°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è')
        .optional(),
    duration: z.number()
        .min(1, '–ú–∏–Ω–∏–º—É–º 1 –º–∏–Ω—É—Ç–∞')
        .max(1440, '–ú–∞–∫—Å–∏–º—É–º 24 —á–∞—Å–∞')
        .optional(),
    maxParticipants: z.number()
        .min(1, '–ú–∏–Ω–∏–º—É–º 1 —É—á–∞—Å—Ç–Ω–∏–∫')
        .max(1000, '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤')
        .optional(),
})
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```jsx
// webapp/src/screens/ActivityCreate.jsx
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { activitySchema } from '../validation/activitySchema'

export default function ActivityCreate() {
    const {
        register,
        handleSubmit,
        formState: { errors },
    } = useForm({
        resolver: zodResolver(activitySchema),
    })

    const createActivity = useCreateActivity()

    const onSubmit = (data) => {
        createActivity.mutate(data, {
            onSuccess: () => {
                // Navigate to activity detail
            },
        })
    }

    return (
        <form onSubmit={handleSubmit(onSubmit)}>
            <div>
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input {...register('title')} />
                {errors.title && <span className="error">{errors.title.message}</span>}
            </div>

            <div>
                <label>–î–∞—Ç–∞</label>
                <input type="datetime-local" {...register('date', { valueAsDate: true })} />
                {errors.date && <span className="error">{errors.date.message}</span>}
            </div>

            {/* ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è */}

            <button type="submit" disabled={createActivity.isLoading}>
                {createActivity.isLoading ? '–°–æ–∑–¥–∞–Ω–∏–µ...' : '–°–æ–∑–¥–∞—Ç—å'}
            </button>
        </form>
    )
}
```

**–§–∞–π–ª—ã:** `webapp/src/validation/*`, –æ–±–Ω–æ–≤–∏—Ç—å —Ñ–æ—Ä–º—ã

---

### 3.5 –¢–µ—Å—Ç—ã –¥–ª—è Frontend (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, 0.5 –¥–Ω—è)

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞:**
```bash
npm install -D vitest @testing-library/react @testing-library/jest-dom @testing-library/user-event
```

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```javascript
// vite.config.js
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
    plugins: [react()],
    test: {
        globals: true,
        environment: 'jsdom',
        setupFiles: './src/test/setup.js',
    },
})
```

**–ü—Ä–∏–º–µ—Ä—ã —Ç–µ—Å—Ç–æ–≤:**
```javascript
// webapp/src/components/__tests__/ActivityCard.test.jsx
import { render, screen } from '@testing-library/react'
import { ActivityCard } from '../ActivityCard'

describe('ActivityCard', () => {
    const mockActivity = {
        id: 1,
        title: 'Morning Run',
        date: '2025-12-16T06:00:00',
        location: 'Central Park',
        distance: 5,
        participants: 10,
        isJoined: false,
    }

    it('renders activity title', () => {
        render(<ActivityCard activity={mockActivity} />)
        expect(screen.getByText('Morning Run')).toBeInTheDocument()
    })

    it('shows join button when not joined', () => {
        render(<ActivityCard activity={mockActivity} />)
        expect(screen.getByText('–ó–∞–ø–∏—Å–∞—Ç—å—Å—è')).toBeInTheDocument()
    })

    it('calls onJoinToggle when button clicked', () => {
        const handleJoin = vi.fn()
        render(<ActivityCard activity={mockActivity} onJoinToggle={handleJoin} />)

        screen.getByText('–ó–∞–ø–∏—Å–∞—Ç—å—Å—è').click()
        expect(handleJoin).toHaveBeenCalledWith(1)
    })
})
```

**–§–∞–π–ª—ã:** `webapp/src/**/__tests__/*.test.jsx`

---

### 3.6 Commit –∏ review Phase 3

**Checklist:**

- [ ] React Query –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω
- [ ] Home.jsx —É–ø—Ä–æ—â–µ–Ω (<200 —Å—Ç—Ä–æ–∫)
- [ ] –°–æ–∑–¥–∞–Ω useWeekNavigation hook
- [ ] DaySection –≤—ã–Ω–µ—Å–µ–Ω –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
- [ ] –°–æ–∑–¥–∞–Ω—ã shared –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (DetailPage, ParticipantsList)
- [ ] Form validation –¥–æ–±–∞–≤–ª–µ–Ω
- [ ] –¢–µ—Å—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ —Ä–µ–≥—Ä–µ—Å—Å–∏–π

**Git:**
```bash
git add .
git commit -m "refactor(frontend): phase 3 - component optimization

- Integrate TanStack Query (React Query)
- Refactor Home.jsx (342 ‚Üí 150 lines)
- Extract DaySection component
- Create useWeekNavigation custom hook
- Add shared DetailPage component
- Add shared ParticipantsList component
- Implement form validation (react-hook-form + zod)
- Add frontend tests (Vitest)

ü§ñ Generated with Claude Code
Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"

git push origin refactor/phase-3-frontend
```

---

## Phase 4: Performance –∏ Testing (3-4 –¥–Ω—è)

### –¶–µ–ª—å
–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ, –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥.

### 4.1 Backend performance optimization (1 –¥–µ–Ω—å)

#### A. Database connection pooling

```python
# storage/db.py
from sqlalchemy.pool import QueuePool

engine = create_engine(
    settings.database_url,
    poolclass=QueuePool,
    pool_size=5,          # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
    max_overflow=10,      # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ
    pool_timeout=30,      # Timeout –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    pool_recycle=3600,    # Recycled –∫–∞–∂–¥—ã–π —á–∞—Å
    echo=settings.debug   # SQL logging —Ç–æ–ª—å–∫–æ –≤ debug
)
```

#### B. Add caching

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞:**
```bash
pip install aiocache
```

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
# api/utils/cache.py
from aiocache import Cache
from aiocache.serializers import JsonSerializer

cache = Cache(
    Cache.MEMORY,
    serializer=JsonSerializer(),
    namespace="ayda_run"
)

# –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
from functools import wraps

def cached(ttl=300):
    """Cache decorator with TTL in seconds"""
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            # Generate cache key
            cache_key = f"{func.__name__}:{str(args)}:{str(kwargs)}"

            # Check cache
            result = await cache.get(cache_key)
            if result is not None:
                return result

            # Call function
            result = await func(*args, **kwargs)

            # Store in cache
            await cache.set(cache_key, result, ttl=ttl)
            return result
        return wrapper
    return decorator
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
# api/routers/activities.py
from api.utils.cache import cached

@router.get("")
@cached(ttl=60)  # Cache for 1 minute
async def list_activities(...):
    # ...
```

#### C. Add request compression

```python
# api_server.py
from fastapi.middleware.gzip import GZIPMiddleware

app.add_middleware(GZIPMiddleware, minimum_size=1000)
```

#### D. Optimize serialization

```python
# schemas/activity.py
from pydantic import BaseModel, ConfigDict

class ActivityResponse(BaseModel):
    model_config = ConfigDict(from_attributes=True)

    # Use Pydantic v2 computed fields
    @computed_field
    @property
    def participants_count(self) -> int:
        return len(self.participations) if self.participations else 0
```

**–§–∞–π–ª—ã:** `storage/db.py`, `api/utils/cache.py`, –æ–±–Ω–æ–≤–∏—Ç—å schemas

---

### 4.2 Frontend performance optimization (0.5 –¥–Ω—è)

#### A. Code splitting

```jsx
// webapp/src/App.jsx
import { lazy, Suspense } from 'react'

// Lazy load screens
const Home = lazy(() => import('./screens/Home'))
const ActivityDetail = lazy(() => import('./screens/ActivityDetail'))
const ActivityCreate = lazy(() => import('./screens/ActivityCreate'))
const ClubsGroups = lazy(() => import('./screens/ClubsGroups'))
const Profile = lazy(() => import('./screens/Profile'))

function App() {
    return (
        <Suspense fallback={<Loading />}>
            <Routes>
                <Route path="/" element={<Home />} />
                <Route path="/activity/:id" element={<ActivityDetail />} />
                {/* ... */}
            </Routes>
        </Suspense>
    )
}
```

#### B. –ú–µ–º–æ–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

```jsx
// webapp/src/components/ActivityCard.jsx
import { memo } from 'react'

export const ActivityCard = memo(function ActivityCard({ activity, onJoinToggle }) {
    // Component code
}, (prevProps, nextProps) => {
    // Custom comparison
    return prevProps.activity.id === nextProps.activity.id &&
           prevProps.activity.isJoined === nextProps.activity.isJoined
})
```

#### C. Virtual scrolling (–¥–ª—è –±–æ–ª—å—à–∏—Ö —Å–ø–∏—Å–∫–æ–≤)

```bash
npm install @tanstack/react-virtual
```

```jsx
// –î–ª—è —Å–ø–∏—Å–∫–æ–≤ —Å >100 —ç–ª–µ–º–µ–Ω—Ç–æ–≤
import { useVirtualizer } from '@tanstack/react-virtual'

function LargeList({ items }) {
    const parentRef = useRef()

    const virtualizer = useVirtualizer({
        count: items.length,
        getScrollElement: () => parentRef.current,
        estimateSize: () => 100, // –ü—Ä–∏–º–µ—Ä–Ω–∞—è –≤—ã—Å–æ—Ç–∞ —ç–ª–µ–º–µ–Ω—Ç–∞
    })

    return (
        <div ref={parentRef} style={{ height: '600px', overflow: 'auto' }}>
            <div style={{ height: `${virtualizer.getTotalSize()}px` }}>
                {virtualizer.getVirtualItems().map(virtualItem => (
                    <div key={virtualItem.index} style={{
                        position: 'absolute',
                        top: 0,
                        left: 0,
                        width: '100%',
                        transform: `translateY(${virtualItem.start}px)`,
                    }}>
                        <ActivityCard activity={items[virtualItem.index]} />
                    </div>
                ))}
            </div>
        </div>
    )
}
```

**–§–∞–π–ª—ã:** –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

---

### 4.3 Comprehensive testing (2 –¥–Ω—è)

#### A. Backend tests (–ø–æ–∫—Ä—ã—Ç–∏–µ 60%+)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```
tests/
‚îú‚îÄ‚îÄ conftest.py          # Fixtures
‚îú‚îÄ‚îÄ test_api/
‚îÇ   ‚îú‚îÄ‚îÄ test_activities.py
‚îÇ   ‚îú‚îÄ‚îÄ test_clubs.py
‚îÇ   ‚îú‚îÄ‚îÄ test_groups.py
‚îÇ   ‚îú‚îÄ‚îÄ test_users.py
‚îÇ   ‚îî‚îÄ‚îÄ test_auth.py
‚îú‚îÄ‚îÄ test_services/
‚îÇ   ‚îú‚îÄ‚îÄ test_activity_service.py
‚îÇ   ‚îú‚îÄ‚îÄ test_club_service.py
‚îÇ   ‚îî‚îÄ‚îÄ test_membership_service.py
‚îú‚îÄ‚îÄ test_models/
‚îÇ   ‚îî‚îÄ‚îÄ test_permissions.py
‚îî‚îÄ‚îÄ test_integration/
    ‚îî‚îÄ‚îÄ test_full_flow.py
```

**–ü—Ä–∏–º–µ—Ä—ã:**

```python
# tests/conftest.py
import pytest
from fastapi.testclient import TestClient
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from storage.db import Base, User, Activity, Club, Group
from api_server import app
from api.dependencies import get_db

# Test database
SQLALCHEMY_TEST_DATABASE_URL = "sqlite:///./test.db"
engine = create_engine(SQLALCHEMY_TEST_DATABASE_URL, connect_args={"check_same_thread": False})
TestingSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

@pytest.fixture(scope="function")
def db_session():
    """Create test database and session"""
    Base.metadata.create_all(bind=engine)
    session = TestingSessionLocal()
    yield session
    session.close()
    Base.metadata.drop_all(bind=engine)

@pytest.fixture
def client(db_session):
    """Test client with database override"""
    def override_get_db():
        yield db_session

    app.dependency_overrides[get_db] = override_get_db
    with TestClient(app) as test_client:
        yield test_client
    app.dependency_overrides.clear()

@pytest.fixture
def test_user(db_session):
    """Create test user"""
    user = User(telegram_id=12345, username="testuser", first_name="Test")
    db_session.add(user)
    db_session.commit()
    db_session.refresh(user)
    return user

@pytest.fixture
def test_activity(db_session, test_user):
    """Create test activity"""
    from datetime import datetime, timedelta
    activity = Activity(
        title="Test Run",
        date=datetime.now() + timedelta(days=1),
        location="Test Park",
        sport_type="running",
        difficulty="easy",
        creator_id=test_user.id
    )
    db_session.add(activity)
    db_session.commit()
    db_session.refresh(activity)
    return activity
```

```python
# tests/test_api/test_activities.py
import pytest
from datetime import datetime, timedelta

def test_create_activity_success(client, test_user):
    """Test creating activity"""
    activity_data = {
        "title": "Morning Run",
        "description": "Easy 5k",
        "date": (datetime.now() + timedelta(days=1)).isoformat(),
        "location": "Central Park",
        "sport_type": "running",
        "difficulty": "easy",
        "distance": 5.0,
    }

    response = client.post(
        "/api/activities",
        json=activity_data,
        headers={"X-Telegram-Init-Data": "mock"}  # Mock auth
    )

    assert response.status_code == 201
    data = response.json()
    assert data["title"] == "Morning Run"
    assert data["creator_id"] == test_user.id

def test_create_activity_past_date_fails(client):
    """Test that creating activity with past date fails"""
    activity_data = {
        "title": "Past Run",
        "date": (datetime.now() - timedelta(days=1)).isoformat(),
        "location": "Park",
        "sport_type": "running",
        "difficulty": "easy",
    }

    response = client.post("/api/activities", json=activity_data)
    assert response.status_code == 422  # Validation error

def test_list_activities_with_filters(client, db_session, test_user):
    """Test listing activities with filters"""
    # Create multiple activities
    activities = [
        Activity(
            title=f"Run {i}",
            date=datetime.now() + timedelta(days=i),
            location="Park",
            sport_type="running" if i % 2 == 0 else "cycling",
            difficulty="easy",
            creator_id=test_user.id
        )
        for i in range(1, 6)
    ]
    db_session.add_all(activities)
    db_session.commit()

    # Filter by sport_type
    response = client.get("/api/activities?sport_type=running")
    assert response.status_code == 200
    data = response.json()
    assert len(data) == 3  # Only running activities

    # Filter by date range
    date_from = (datetime.now() + timedelta(days=2)).isoformat()
    date_to = (datetime.now() + timedelta(days=4)).isoformat()
    response = client.get(f"/api/activities?date_from={date_from}&date_to={date_to}")
    assert response.status_code == 200
    data = response.json()
    assert len(data) == 3

def test_join_activity_success(client, test_activity, test_user):
    """Test joining activity"""
    response = client.post(
        f"/api/activities/{test_activity.id}/join",
        headers={"X-Telegram-Init-Data": "mock"}
    )

    assert response.status_code == 200
    data = response.json()
    assert data["status"] == "joined"

def test_join_full_activity_fails(client, db_session, test_activity, test_user):
    """Test that joining full activity fails"""
    # Set max participants
    test_activity.max_participants = 1
    db_session.commit()

    # Join first user
    client.post(f"/api/activities/{test_activity.id}/join")

    # Try to join second user (should fail)
    user2 = User(telegram_id=99999, username="user2")
    db_session.add(user2)
    db_session.commit()

    # Mock auth for user2
    response = client.post(
        f"/api/activities/{test_activity.id}/join",
        headers={"X-Telegram-Init-Data": "user2_mock"}
    )

    assert response.status_code == 400
    assert "full" in response.json()["detail"].lower()
```

```python
# tests/test_integration/test_full_flow.py
def test_full_activity_lifecycle(client, db_session, test_user):
    """Test complete activity lifecycle"""

    # 1. Create activity
    activity_data = {
        "title": "Integration Test Run",
        "date": (datetime.now() + timedelta(days=1)).isoformat(),
        "location": "Test Park",
        "sport_type": "running",
        "difficulty": "easy",
    }
    response = client.post("/api/activities", json=activity_data)
    assert response.status_code == 201
    activity_id = response.json()["id"]

    # 2. Get activity details
    response = client.get(f"/api/activities/{activity_id}")
    assert response.status_code == 200
    assert response.json()["title"] == "Integration Test Run"

    # 3. Join activity
    response = client.post(f"/api/activities/{activity_id}/join")
    assert response.status_code == 200
    assert response.json()["status"] == "joined"

    # 4. Get participants
    response = client.get(f"/api/activities/{activity_id}/participants")
    assert response.status_code == 200
    participants = response.json()
    assert len(participants) == 1
    assert participants[0]["username"] == "testuser"

    # 5. Leave activity
    response = client.post(f"/api/activities/{activity_id}/join")
    assert response.status_code == 200
    assert response.json()["status"] == "left"

    # 6. Delete activity
    response = client.delete(f"/api/activities/{activity_id}")
    assert response.status_code == 204

    # 7. Verify deleted
    response = client.get(f"/api/activities/{activity_id}")
    assert response.status_code == 404
```

**–ó–∞–ø—É—Å–∫:**
```bash
pytest tests/ -v --cov=api --cov=storage --cov-report=html
```

**–§–∞–π–ª—ã:** `tests/**/*.py`

---

#### B. Frontend tests (–ø–æ–∫—Ä—ã—Ç–∏–µ 40%+)

**–ü—Ä–∏–º–µ—Ä—ã:**

```javascript
// webapp/src/hooks/__tests__/useWeekNavigation.test.js
import { renderHook, act } from '@testing-library/react'
import { useWeekNavigation } from '../useWeekNavigation'

describe('useWeekNavigation', () => {
    const mockActivities = [
        {
            id: 1,
            date: '2025-12-15T10:00:00',  // Current week
            isJoined: true,
        },
        {
            id: 2,
            date: '2025-12-22T10:00:00',  // Next week
            isJoined: false,
        },
    ]

    it('initializes with current week', () => {
        const { result } = renderHook(() => useWeekNavigation(mockActivities, 'all'))

        expect(result.current.displayedWeek).not.toBeNull()
        expect(result.current.displayedWeek.weekNumber).toBe(0)
    })

    it('filters by mode', () => {
        const { result, rerender } = renderHook(
            ({ activities, mode }) => useWeekNavigation(activities, mode),
            { initialProps: { activities: mockActivities, mode: 'all' } }
        )

        // 'all' mode shows both
        expect(Object.keys(result.current.displayedWeek.days).length).toBeGreaterThan(0)

        // 'my' mode shows only joined
        rerender({ activities: mockActivities, mode: 'my' })
        // Should have fewer activities
    })

    it('navigates to next week', () => {
        const { result } = renderHook(() => useWeekNavigation(mockActivities, 'all'))

        act(() => {
            result.current.goToNextWeek()
        })

        expect(result.current.displayedWeek.weekNumber).toBe(1)
    })
})
```

**–ó–∞–ø—É—Å–∫:**
```bash
npm run test
npm run test:coverage
```

**–§–∞–π–ª—ã:** `webapp/src/**/__tests__/*.test.jsx`

---

### 4.4 –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (0.5 –¥–Ω—è)

#### A. Add Sentry (error tracking)

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞:**
```bash
pip install sentry-sdk[fastapi]
npm install @sentry/react
```

**Backend:**
```python
# api_server.py
import sentry_sdk
from sentry_sdk.integrations.fastapi import FastApiIntegration

if not settings.debug:
    sentry_sdk.init(
        dsn=settings.sentry_dsn,
        integrations=[FastApiIntegration()],
        traces_sample_rate=0.1,
        environment="production",
    )
```

**Frontend:**
```javascript
// webapp/src/main.jsx
import * as Sentry from "@sentry/react"

if (import.meta.env.PROD) {
    Sentry.init({
        dsn: import.meta.env.VITE_SENTRY_DSN,
        integrations: [
            new Sentry.BrowserTracing(),
            new Sentry.Replay(),
        ],
        tracesSampleRate: 0.1,
        replaysSessionSampleRate: 0.1,
        replaysOnErrorSampleRate: 1.0,
    })
}
```

#### B. Add health check endpoint

```python
# api/routers/health.py
from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session
from api.dependencies import get_db

router = APIRouter(tags=["health"])

@router.get("/health")
async def health_check():
    """Health check endpoint"""
    return {"status": "healthy", "version": "2.0.0"}

@router.get("/health/db")
async def database_health(db: Session = Depends(get_db)):
    """Database health check"""
    try:
        # Simple query
        db.execute("SELECT 1")
        return {"status": "healthy", "database": "connected"}
    except Exception as e:
        return {"status": "unhealthy", "database": str(e)}
```

**–§–∞–π–ª—ã:** `api/routers/health.py`, –æ–±–Ω–æ–≤–∏—Ç—å `config.py`

---

### 4.5 Commit –∏ review Phase 4

**Checklist:**

- [ ] Database pooling –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] Caching –¥–æ–±–∞–≤–ª–µ–Ω
- [ ] Request compression –≤–∫–ª—é—á–µ–Ω
- [ ] Frontend code splitting —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- [ ] Backend test coverage 60%+
- [ ] Frontend test coverage 40%+
- [ ] Integration tests –Ω–∞–ø–∏—Å–∞–Ω—ã
- [ ] Sentry –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] Health checks –¥–æ–±–∞–≤–ª–µ–Ω—ã

**Git:**
```bash
git add .
git commit -m "feat(performance): phase 4 - optimization and testing

Backend:
- Add database connection pooling
- Implement caching with aiocache
- Add GZIP compression
- Optimize serialization

Frontend:
- Implement code splitting
- Add component memoization
- Add virtual scrolling for large lists

Testing:
- Backend test coverage 60%+
- Frontend test coverage 40%+
- Integration tests for full flows
- E2E critical paths

Monitoring:
- Integrate Sentry error tracking
- Add health check endpoints

ü§ñ Generated with Claude Code
Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"

git push origin refactor/phase-4-performance
```

---

## Phase 5: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (1-2 –¥–Ω—è)

### –¶–µ–ª—å
–£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞, –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production.

### 5.1 Code review checklist (0.5 –¥–Ω—è)

**Backend:**

- [ ] –í—Å–µ endpoints –∏–º–µ—é—Ç Pydantic schemas
- [ ] –í—Å–µ endpoints –ª–æ–≥–∏—Ä—É—é—Ç –¥–µ–π—Å—Ç–≤–∏—è
- [ ] Rate limiting –ø—Ä–∏–º–µ–Ω–µ–Ω –∫ –∫—Ä–∏—Ç–∏—á–Ω—ã–º endpoints
- [ ] Auth —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (dev mode —Ç–æ–ª—å–∫–æ –≤ DEBUG)
- [ ] CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- [ ] Database queries –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã (–Ω–µ—Ç N+1)
- [ ] Indexes –¥–æ–±–∞–≤–ª–µ–Ω—ã
- [ ] –ù–µ—Ç debug prints
- [ ] Secrets –≤ environment variables
- [ ] Error handling –≤–µ–∑–¥–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω

**Frontend:**

- [ ] React Query –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö API calls
- [ ] Forms –∏–º–µ—é—Ç validation
- [ ] Loading states –≤–µ–∑–¥–µ
- [ ] Error states –≤–µ–∑–¥–µ
- [ ] –ù–µ—Ç console.log –≤ production –∫–æ–¥–µ
- [ ] Code splitting —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- [ ] –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è

**Tests:**

- [ ] Backend coverage 60%+
- [ ] Frontend coverage 40%+
- [ ] Integration tests –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç

---

### 5.2 –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é (0.5 –¥–Ω—è)

**–û–±–Ω–æ–≤–∏—Ç—å:**

- [ ] `README.md` - –Ω–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- [ ] `docs/ARCHITECTURE.md` - –º–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- [ ] `docs/API_DOCS.md` - –≤—Å–µ endpoints (—Å–æ–∑–¥–∞—Ç—å –µ—Å–ª–∏ –Ω–µ—Ç)
- [ ] `docs/DEPLOYMENT.md` - production deployment guide
- [ ] –î–æ–±–∞–≤–∏—Ç—å `CHANGELOG.md`

**–°–æ–∑–¥–∞—Ç—å:**
```markdown
# CHANGELOG.md

## [2.0.0] - 2025-12-XX

### Added
- Modular API architecture (routers, services)
- Pydantic request/response validation
- Rate limiting
- Logging middleware
- Database indexes
- React Query integration
- Form validation (react-hook-form + zod)
- Comprehensive test suite
- Sentry error tracking
- Health check endpoints

### Changed
- Refactored Home.jsx (342 ‚Üí 150 lines)
- Improved auth security (dev mode check)
- Optimized database queries
- Better CORS configuration

### Removed
- Debug print statements
- Duplicate code in groups/clubs APIs

### Fixed
- N+1 query problems
- Dev mode auth bypass in production
```

**–§–∞–π–ª—ã:** –æ–±–Ω–æ–≤–∏—Ç—å `docs/*`, —Å–æ–∑–¥–∞—Ç—å `CHANGELOG.md`

---

### 5.3 Production deployment checklist (0.5 –¥–Ω—è)

**Environment variables:**

```bash
# .env.production
TELEGRAM_BOT_TOKEN=<production_token>
WEB_APP_URL=<production_url>
DATABASE_URL=<postgresql_url>
CORS_ORIGINS=["https://your-domain.com","https://t.me"]
DEBUG=false
LOG_LEVEL=INFO
SENTRY_DSN=<sentry_dsn>
```

**Database migrations:**
```bash
# –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
alembic upgrade head
```

**Build frontend:**
```bash
cd webapp
npm run build
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å dist/
```

**Test production build –ª–æ–∫–∞–ª—å–Ω–æ:**
```bash
# Set production env
export DEBUG=false
export DATABASE_URL=postgresql://...

# Run
python api_server.py

# Test
curl http://localhost:8000/health
curl http://localhost:8000/health/db
```

**Checklist:**

- [ ] Environment variables –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [ ] Database migrations –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
- [ ] Frontend —Å–æ–±—Ä–∞–Ω (`dist/` –≥–æ—Ç–æ–≤)
- [ ] Sentry DSN –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] Health checks —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] CORS –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è production
- [ ] Rate limiting —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Logging –Ω–∞—Å—Ç—Ä–æ–µ–Ω

---

### 5.4 Performance testing (0.5 –¥–Ω—è)

**Load testing —Å Locust:**

```bash
pip install locust
```

```python
# locustfile.py
from locust import HttpUser, task, between

class AydaRunUser(HttpUser):
    wait_time = between(1, 3)

    @task(3)
    def list_activities(self):
        self.client.get("/api/activities")

    @task(2)
    def get_activity_detail(self):
        self.client.get("/api/activities/1")

    @task(1)
    def join_activity(self):
        self.client.post("/api/activities/1/join")
```

**–ó–∞–ø—É—Å–∫:**
```bash
locust -f locustfile.py --host=http://localhost:8000
```

**–ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**
- Response time < 200ms –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
- Throughput > 100 req/s
- Error rate < 1%

---

### 5.5 Security audit (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, 0.5 –¥–Ω—è)

**Checklist:**

- [ ] SQL injection –∑–∞—â–∏—Ç–∞ (Pydantic + SQLAlchemy)
- [ ] XSS –∑–∞—â–∏—Ç–∞ (React escaping)
- [ ] CSRF –∑–∞—â–∏—Ç–∞ (SameSite cookies, –Ω–µ –Ω—É–∂–Ω–æ –¥–ª—è Telegram WebApp)
- [ ] Rate limiting —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Secrets –Ω–µ –≤ –∫–æ–¥–µ
- [ ] Auth –ø—Ä–æ–≤–µ—Ä–µ–Ω
- [ ] Input validation –≤–µ–∑–¥–µ
- [ ] Output encoding –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
- [ ] HTTPS enforced (–Ω–∞ production)
- [ ] CORS –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**
```bash
# Bandit (Python security)
pip install bandit
bandit -r api/ storage/ -f json -o security_report.json

# Safety (dependency vulnerabilities)
pip install safety
safety check

# npm audit (frontend)
cd webapp && npm audit
```

---

### 5.6 Final commit –∏ merge

**Checklist:**

- [ ] –í—Å–µ tests –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] Coverage –¥–æ—Å—Ç–∏–≥–Ω—É—Ç
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [ ] CHANGELOG —Å–æ–∑–¥–∞–Ω
- [ ] Production build —É—Å–ø–µ—à–µ–Ω
- [ ] Performance –ø—Ä–∏–µ–º–ª–µ–º—ã–π
- [ ] Security audit –ø—Ä–æ–π–¥–µ–Ω

**Git:**
```bash
git add .
git commit -m "docs: phase 5 - final documentation and production readiness

- Update all documentation
- Create CHANGELOG.md
- Add production deployment guide
- Performance testing results
- Security audit passed

Ready for production deployment

ü§ñ Generated with Claude Code
Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"

git push origin refactor/phase-5-final

# Create PR for review
gh pr create --title "Refactoring: Production-ready architecture" \
  --body "Complete refactoring with modular architecture, testing, and optimization. Ready for production deployment."
```

**Merge:**
```bash
# –ü–æ—Å–ª–µ code review
git checkout master
git merge refactor/phase-5-final
git push origin master

# Tag version
git tag -a v2.0.0 -m "Release 2.0.0 - Production-ready refactored architecture"
git push origin v2.0.0
```

---

## –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –†–∞–±–æ—Ç–∞ —Å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–æ–º

1. **–ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä—å—Ç–µ –±–µ–∑ —Ç–µ—Å—Ç–æ–≤**
   - –°–Ω–∞—á–∞–ª–∞ tests, –ø–æ—Ç–æ–º refactor
   - –ó–∞–ø—É—Å–∫–∞–π—Ç–µ —Ç–µ—Å—Ç—ã –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è

2. **–ú–∞–ª–µ–Ω—å–∫–∏–µ commits**
   - –û–¥–∏–Ω commit = –æ–¥–Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∞—è –∏–∑–º–µ–Ω–µ–Ω–∏–µ
   - –õ–µ–≥—á–µ –æ—Ç–∫–∞—Ç–∏—Ç—å –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫

3. **Feature flags –¥–ª—è –±–æ–ª—å—à–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π**
   ```python
   # config.py
   use_new_api_structure: bool = Field(default=False)

   # api_server.py
   if settings.use_new_api_structure:
       app.include_router(new_router)
   else:
       app.include_router(old_router)
   ```

4. **Parallel —Ä–∞–±–æ—Ç–∞ —Å—Ç–∞—Ä–æ–≥–æ –∏ –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞**
   - –ó–∞–ø—É—Å–∫–∞–π—Ç–µ –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
   - –°—Ä–∞–≤–Ω–∏–≤–∞–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
   - –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–π—Ç–µ traffic

5. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Ä–µ—à–µ–Ω–∏—è**
   - –ü–æ—á–µ–º—É –≤—ã–±—Ä–∞–ª–∏ —ç—Ç–æ—Ç –ø–æ–¥—Ö–æ–¥
   - –ö–∞–∫–∏–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–ª–∏
   - –ß—Ç–æ –º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å—Å—è

### Rollback –ø–ª–∞–Ω

–î–ª—è –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã –∏–º–µ—Ç—å plan B:

```bash
# Phase 1 rollback
git revert <commit-hash>
git push origin master

# Phase 2 rollback (–µ—Å–ª–∏ merged)
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ feature flag –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –Ω–æ–≤—ã—Ö routers
export USE_NEW_API_STRUCTURE=false

# Database migration rollback
alembic downgrade -1
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Å–ª–µ deploy

**–ü–µ—Ä–≤—ã–µ 24 —á–∞—Å–∞:**
- [ ] –ü—Ä–æ–≤–µ—Ä—è—Ç—å Sentry –∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å response times
- [ ] –ü—Ä–æ–≤–µ—Ä—è—Ç—å error rates
- [ ] –ß–∏—Ç–∞—Ç—å user feedback

**–ü–µ—Ä–≤–∞—è –Ω–µ–¥–µ–ª—è:**
- [ ] Daily Sentry review
- [ ] Performance metrics analysis
- [ ] Database query performance
- [ ] User retention metrics

---

## –ò—Ç–æ–≥–æ–≤—ã–π Timeline

| Phase | –ó–∞–¥–∞—á–∏ | –í—Ä–µ–º—è | –°—Ç–∞—Ç—É—Å |
|-------|--------|-------|--------|
| 1 | Security & Testing Setup | 2-3 –¥–Ω—è | ‚è≥ Pending |
| 2 | Backend Refactoring | 3-4 –¥–Ω—è | ‚è≥ Pending |
| 3 | Frontend Optimization | 2-3 –¥–Ω—è | ‚è≥ Pending |
| 4 | Performance & Testing | 3-4 –¥–Ω—è | ‚è≥ Pending |
| 5 | Final Check & Deploy | 1-2 –¥–Ω—è | ‚è≥ Pending |
| **TOTAL** | | **11-16 –¥–Ω–µ–π** | |

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ 14 –¥–Ω–µ–π (2 –Ω–µ–¥–µ–ª–∏) —Å –∑–∞–ø–∞—Å–æ–º –Ω–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã.

---

## –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

**Code Quality:**
- ‚úÖ Backend test coverage ‚â• 60%
- ‚úÖ Frontend test coverage ‚â• 40%
- ‚úÖ –ù–µ—Ç –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö security issues
- ‚úÖ Code complexity —Å–Ω–∏–∂–µ–Ω –Ω–∞ 40%+

**Performance:**
- ‚úÖ API response time < 200ms (p95)
- ‚úÖ Frontend load time < 2s
- ‚úÖ Database queries –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã (–Ω–µ—Ç N+1)

**Maintainability:**
- ‚úÖ –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- ‚úÖ CI/CD pipeline —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ features

**Production Ready:**
- ‚úÖ –í—Å–µ environment variables –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- ‚úÖ Logging –∏ monitoring —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ Error tracking –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- ‚úÖ Health checks —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ Rollback –ø–ª–∞–Ω –≥–æ—Ç–æ–≤

---

## –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –ø–æ–º–æ—â—å

**–í–æ–ø—Ä–æ—Å—ã –ø–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É:**
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –∫–∞–∫ —á–µ–∫-–ª–∏—Å—Ç
- –ö–∞–∂–¥—É—é —Ñ–∞–∑—É –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
- –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö - –æ—Ç–∫–∞—Ç—ã–≤–∞–π—Ç–µ—Å—å –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π commit

**Best practices:**
- –ö–æ–¥ —Ä–µ–≤—å—é –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ staging –ø–µ—Ä–µ–¥ production
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ deploy

---

**–ì–æ—Ç–æ–≤–æ –∫ —Å—Ç–∞—Ä—Ç—É!** üöÄ
