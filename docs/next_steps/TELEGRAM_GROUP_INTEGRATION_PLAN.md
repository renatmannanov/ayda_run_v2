# –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram –≥—Ä—É–ø–ø–∞–º–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—É–±–æ–≤

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-12-19
**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2025-12-19
**–°—Ç–∞—Ç—É—Å:** üîµ –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–æ–±–Ω–æ–≤–ª—ë–Ω)

---

## –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

**–¶–µ–ª—å:** –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª—É–±–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö Telegram –≥—Ä—É–ø–ø

**–°—Ü–µ–Ω–∞—Ä–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
1. –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –¥–æ–±–∞–≤–ª—è–µ—Ç –±–æ—Ç–∞ –≤ Telegram –≥—Ä—É–ø–ø—É –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
2. –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –≤—ã–∑—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É `/create_club` –≤ –≥—Ä—É–ø–ø–µ
3. –ë–æ—Ç –ø–∞—Ä—Å–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥—Ä—É–ø–ø–µ
4. –ë–æ—Ç —Å–æ–∑–¥–∞–µ—Ç –∫–ª—É–± –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ø–∞—Ä—Å–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
5. –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏ —Å—Å—ã–ª–∫—É –Ω–∞ –∫–ª—É–± –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P1 (–≤–∞–∂–Ω–æ –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–≤)

---

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø–ª–∞–Ω–µ (2025-12-19)

### ‚úÖ –ß—Ç–æ —É–∂–µ –≥–æ—Ç–æ–≤–æ –≤ –∫–æ–¥–æ–≤–æ–π –±–∞–∑–µ:
- ‚úÖ –ú–æ–¥–µ–ª–∏ –ë–î: `telegram_chat_id`, `invite_link`, `username`, `photo` –≤ Club/Group
- ‚úÖ Storage Layer: UserStorage, ClubStorage, GroupStorage, MembershipStorage
- ‚úÖ Deep links: —Ñ–æ—Ä–º–∞—Ç `club_{UUID}` –∏ `group_{UUID}` —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ WebApp deep links: `{app_url}?startapp=club_{UUID}`

### üîß –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:
- ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω** `BOT_USERNAME` –≤ config.py –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö deep links
- üîÑ **–ò–∑–º–µ–Ω—ë–Ω** handler: `bot/group_club_creation_handler.py` –≤–º–µ—Å—Ç–æ `group_integration_handler.py`
- üîÑ **–£–ø—Ä–æ—â–µ–Ω–∞** –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏–∑ onboarding
- ‚ûï **–î–æ–±–∞–≤–ª–µ–Ω—ã** –º–µ—Ç–æ–¥—ã –≤ ClubStorage: `get_club_by_telegram_chat_id()`, `create_club_from_telegram_group()`

### üìù –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è (–æ—Ç–ª–æ–∂–µ–Ω–æ):
- ‚è≥ **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø—ã** - –∫–æ–º–∞–Ω–¥–∞ `/update_club` (–ø–æ–∑–∂–µ)
- ‚è≥ **–û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –±–æ—Ç–∞** - webhook `my_chat_member` (–ø–æ–∑–∂–µ, —Ç—Ä–µ–±—É–µ—Ç –ª–æ–≥–∏–∫—É –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏)

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° –ì–†–£–ü–ü–ê–ú–ò                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                             ‚îÇ
‚îÇ  1. TelegramGroupParser (bot/group_parser.py)               ‚îÇ
‚îÇ     - –ü–∞—Ä—Å–∏–Ω–≥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≥—Ä—É–ø–ø–µ                           ‚îÇ
‚îÇ     - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –±–æ—Ç–∞ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è                     ‚îÇ
‚îÇ     - –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞ –∏ invite link                       ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  2. GroupClubCreationHandler (bot/group_club_creation_handler.py) ‚îÇ
‚îÇ     - ConversationHandler –¥–ª—è /create_club –≤ –≥—Ä—É–ø–ø–∞—Ö        ‚îÇ
‚îÇ     - Preview ‚Üí Confirmation ‚Üí Sports ‚Üí Creation            ‚îÇ
‚îÇ     - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç TelegramGroupParser                        ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  3. ClubStorage (–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è)                                ‚îÇ
‚îÇ     - create_club_from_telegram_group()                     ‚îÇ
‚îÇ     - get_club_by_telegram_chat_id()                        ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  4. Deep Links –≥–µ–Ω–µ—Ä–∞—Ü–∏—è                                    ‚îÇ
‚îÇ     - https://t.me/{BOT_USERNAME}?start=club_{UUID}         ‚îÇ
‚îÇ     - {WEB_APP_URL}?startapp=club_{UUID}                    ‚îÇ
‚îÇ                                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –§–∞–∑—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### üìã –§–ê–ó–ê 1: Group Info Parser –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏

**–¶–µ–ª—å:** –ü–æ–ª—É—á–∏—Ç—å –≤—Å—é –¥–æ—Å—Ç—É–ø–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥—Ä—É–ø–ø–µ –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞

#### Task 1.1: –°–æ–∑–¥–∞—Ç—å TelegramGroupParser

**–§–∞–π–ª:** `bot/group_parser.py`

```python
"""
Telegram Group Parser

–ü–∞—Ä—Å–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ Telegram –≥—Ä—É–ø–ø–∞—Ö –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—É–±–æ–≤.
"""

from typing import Optional, Dict, Any
from telegram import Bot, ChatMember
import logging

logger = logging.getLogger(__name__)


class TelegramGroupParser:
    """
    –ü–∞—Ä—Å–µ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ Telegram –≥—Ä—É–ø–ø–µ

    –ò–∑–≤–ª–µ–∫–∞–µ—Ç:
    - –ë–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (–Ω–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ, username)
    - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)
    - –ú–µ–¥–∏–∞ (–∞–≤–∞—Ç–∞—Ä –≥—Ä—É–ø–ø—ã)
    - –°—Å—ã–ª–∫–∏ (invite link)
    """

    async def parse_group_info(self, chat_id: int, bot: Bot) -> Dict[str, Any]:
        """
        –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥—Ä—É–ø–ø–µ

        Returns:
            {
                'chat_id': int,
                'title': str,
                'description': str,
                'username': str,  # @groupname (–±–µ–∑ @)
                'member_count': int,
                'invite_link': str,
                'photo': str,  # file_id –∞–≤–∞—Ç–∞—Ä–∞
                'type': str,  # 'group' –∏–ª–∏ 'supergroup'
            }
        """
        try:
            # –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —á–∞—Ç–µ
            chat = await bot.get_chat(chat_id)

            # –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            member_count = await bot.get_chat_member_count(chat_id)

            # –ü–æ–ª—É—á–∏—Ç—å invite link (–∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –µ—Å–ª–∏ –Ω–µ—Ç)
            invite_link = await self.get_invite_link(chat_id, bot)

            # –ü–æ–ª—É—á–∏—Ç—å –∞–≤–∞—Ç–∞—Ä
            photo_file_id = await self.get_group_photo(chat_id, bot)

            return {
                'chat_id': chat_id,
                'title': chat.title,
                'description': chat.description or '',
                'username': chat.username or '',  # –ë–µ–∑ @
                'member_count': member_count,
                'invite_link': invite_link,
                'photo': photo_file_id,
                'type': chat.type,  # 'group' –∏–ª–∏ 'supergroup'
            }

        except Exception as e:
            logger.error(f"Error parsing group info for {chat_id}: {e}", exc_info=True)
            raise

    async def get_group_photo(self, chat_id: int, bot: Bot) -> Optional[str]:
        """
        –ü–æ–ª—É—á–∏—Ç—å file_id –∞–≤–∞—Ç–∞—Ä–∞ –≥—Ä—É–ø–ø—ã

        Returns:
            file_id –∏–ª–∏ None –µ—Å–ª–∏ –∞–≤–∞—Ç–∞—Ä–∞ –Ω–µ—Ç
        """
        try:
            chat = await bot.get_chat(chat_id)
            if chat.photo:
                return chat.photo.big_file_id
            return None
        except Exception as e:
            logger.error(f"Error getting group photo: {e}")
            return None

    async def get_invite_link(self, chat_id: int, bot: Bot) -> Optional[str]:
        """
        –ü–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å invite link

        –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ—Ç –ø–æ–ª—É—á–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π primary invite link.
        –ï—Å–ª–∏ –Ω–µ—Ç - —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π.
        """
        try:
            chat = await bot.get_chat(chat_id)

            # –ï—Å–ª–∏ –µ—Å—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π username
            if chat.username:
                return f"https://t.me/{chat.username}"

            # –ï—Å–ª–∏ –µ—Å—Ç—å invite_link
            if chat.invite_link:
                return chat.invite_link

            # –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π invite link
            invite_link = await bot.export_chat_invite_link(chat_id)
            return invite_link

        except Exception as e:
            logger.error(f"Error getting invite link: {e}")
            return None

    async def verify_bot_is_admin(self, chat_id: int, bot: Bot) -> tuple[bool, str]:
        """
        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –±–æ—Ç —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –≥—Ä—É–ø–ø—ã

        –¢—Ä–µ–±—É–µ–º—ã–µ –ø—Ä–∞–≤–∞:
        - can_invite_users (–¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è invite links)

        Returns:
            (is_admin: bool, error_message: str)
        """
        try:
            bot_user = await bot.get_me()
            member = await bot.get_chat_member(chat_id, bot_user.id)

            if member.status not in ['administrator', 'creator']:
                return False, "–ë–æ—Ç –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –≥—Ä—É–ø–ø—ã"

            # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞
            if not member.can_invite_users:
                return False, "–£ –±–æ—Ç–∞ –Ω–µ—Ç –ø—Ä–∞–≤–∞ '–ü—Ä–∏–≥–ª–∞—à–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π'"

            return True, ""

        except Exception as e:
            logger.error(f"Error verifying bot admin: {e}")
            return False, f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤: {str(e)}"

    async def verify_user_is_admin(self, chat_id: int, user_id: int, bot: Bot) -> tuple[bool, str]:
        """
        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –∏–ª–∏ —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º

        Returns:
            (is_admin: bool, error_message: str)
        """
        try:
            member = await bot.get_chat_member(chat_id, user_id)

            if member.status not in ['administrator', 'creator']:
                return False, "–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–ª—É–±—ã"

            return True, ""

        except Exception as e:
            logger.error(f"Error verifying user admin: {e}")
            return False, f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤: {str(e)}"

    async def get_user_status(self, chat_id: int, user_id: int, bot: Bot) -> str:
        """
        –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø–µ

        Returns: 'creator', 'administrator', 'member', 'restricted', 'left', 'kicked'
        """
        try:
            member = await bot.get_chat_member(chat_id, user_id)
            return member.status
        except Exception as e:
            logger.error(f"Error getting user status: {e}")
            return "unknown"
```

**–ß—Ç–æ –ø–∞—Ä—Å–∏–º:**

| –î–∞–Ω–Ω—ã–µ | Telegram API | –ú–∞–ø–ø–∏–Ω–≥ –≤ Club |
|--------|--------------|----------------|
| –ù–∞–∑–≤–∞–Ω–∏–µ | `chat.title` | `club.name` |
| –û–ø–∏—Å–∞–Ω–∏–µ | `chat.description` | `club.description` |
| Username | `chat.username` | `club.username` |
| –£—á–∞—Å—Ç–Ω–∏–∫–∏ | `bot.get_chat_member_count()` | –î–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ |
| Invite link | `chat.invite_link` –∏–ª–∏ `export_chat_invite_link()` | `club.invite_link` |
| –ê–≤–∞—Ç–∞—Ä | `chat.photo.big_file_id` | `club.photo` |
| Chat ID | `chat.id` | `club.telegram_chat_id` |

**–°—Ç–∞—Ç—É—Å:** ‚¨ú –ù–µ –Ω–∞—á–∞—Ç–æ

---

### üì¶ –§–ê–ó–ê 2: Club Creation Handler

**–¶–µ–ª—å:** –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã `/create_club` –≤ –≥—Ä—É–ø–ø–µ

#### Task 2.1: –°–æ–∑–¥–∞—Ç—å handler –¥–ª—è –∫–æ–º–∞–Ω–¥—ã `/create_club`

**–§–∞–π–ª:** `bot/group_club_creation_handler.py`

```python
"""
Group Club Creation Handler

–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª—É–±–æ–≤ –∏–∑ Telegram –≥—Ä—É–ø–ø —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É /create_club.
"""

import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ConversationHandler,
    CommandHandler,
    CallbackQueryHandler,
    ContextTypes
)

from bot.group_parser import TelegramGroupParser
from storage.user_storage import UserStorage
from storage.club_storage import ClubStorage
from storage.membership_storage import MembershipStorage
from storage.db import UserRole
from config import settings

logger = logging.getLogger(__name__)

# Conversation states
CONFIRMING_CLUB_CREATION = 1
SELECTING_SPORTS = 2
FINALIZING = 3


class GroupIntegrationError(Exception):
    """–ë–∞–∑–æ–≤–∞—è –æ—à–∏–±–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≥—Ä—É–ø–ø–æ–π"""
    pass


class BotNotAdminError(GroupIntegrationError):
    """–ë–æ—Ç –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º"""
    pass


class UserNotAdminError(GroupIntegrationError):
    """–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º"""
    pass


class GroupAlreadyLinkedError(GroupIntegrationError):
    """–ì—Ä—É–ø–ø–∞ —É–∂–µ —Å–≤—è–∑–∞–Ω–∞ —Å –∫–ª—É–±–æ–º"""
    pass


class NotInGroupError(GroupIntegrationError):
    """–ö–æ–º–∞–Ω–¥–∞ –≤—ã–∑–≤–∞–Ω–∞ –Ω–µ –≤ –≥—Ä—É–ø–ø–µ"""
    pass


async def create_club_from_group(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    Handler –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /create_club –≤ –≥—Ä—É–ø–ø–µ

    Flow:
    1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ –≤—ã–∑–≤–∞–Ω–∞ –≤ –≥—Ä—É–ø–ø–µ (–Ω–µ –≤ –õ–°)
    2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –∞–¥–º–∏–Ω/—Å–æ–∑–¥–∞—Ç–µ–ª—å –≥—Ä—É–ø–ø—ã
    3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –±–æ—Ç - –∞–¥–º–∏–Ω –≥—Ä—É–ø–ø—ã
    4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≥—Ä—É–ø–ø–∞ –µ—â–µ –Ω–µ —Å–≤—è–∑–∞–Ω–∞ —Å –∫–ª—É–±–æ–º
    5. –°–ø–∞—Ä—Å–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥—Ä—É–ø–ø–µ
    6. –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–≤—å—é –∫–ª—É–±–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    7. –ó–∞–ø—Ä–æ—Å–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    8. –ü—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ -> –≤—ã–±–æ—Ä —Å–ø–æ—Ä—Ç–æ–≤ -> —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª—É–±–∞
    """
    try:
        message = update.message
        user = message.from_user
        chat = message.chat

        # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ –≤ –≥—Ä—É–ø–ø–µ
        if chat.type not in ['group', 'supergroup']:
            await message.reply_text(
                "‚ÑπÔ∏è –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–∞—Ö\n\n"
                "–î–æ–±–∞–≤—å—Ç–µ –º–µ–Ω—è –≤ –≥—Ä—É–ø–ø—É –∏ –≤—ã–∑–æ–≤–∏—Ç–µ /create_club —Ç–∞–º."
            )
            return ConversationHandler.END

        parser = TelegramGroupParser()

        # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        is_user_admin, error_msg = await parser.verify_user_is_admin(
            chat.id, user.id, context.bot
        )
        if not is_user_admin:
            await message.reply_text(
                f"‚ùå {error_msg}\n\n"
                "–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –∏ —Å–æ–∑–¥–∞—Ç–µ–ª—å –≥—Ä—É–ø–ø—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–ª—É–±—ã."
            )
            return ConversationHandler.END

        # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –±–æ—Ç–∞
        is_bot_admin, error_msg = await parser.verify_bot_is_admin(
            chat.id, context.bot
        )
        if not is_bot_admin:
            await message.reply_text(
                f"‚ùå {error_msg}\n\n"
                "–ß—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –∫–ª—É–±, –¥–æ–±–∞–≤—å—Ç–µ –º–µ–Ω—è –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å –ø—Ä–∞–≤–∞–º–∏:\n"
                "‚ñ™Ô∏è –ü—Ä–∏–≥–ª–∞—à–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n"
                "‚ñ™Ô∏è –ß–∏—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è"
            )
            return ConversationHandler.END

        # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –≥—Ä—É–ø–ø–∞ –Ω–µ —Å–≤—è–∑–∞–Ω–∞ —Å –∫–ª—É–±–æ–º
        with ClubStorage() as club_storage:
            existing_club = club_storage.get_club_by_telegram_chat_id(chat.id)
            if existing_club:
                # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è deep link
                club_link = f"https://t.me/{settings.bot_username}?start=club_{existing_club.id}"
                webapp_url = f"{settings.app_url}?startapp=club_{existing_club.id}"

                await message.reply_text(
                    f"‚ùå –ì—Ä—É–ø–ø–∞ —É–∂–µ —Å–≤—è–∑–∞–Ω–∞ —Å –∫–ª—É–±–æ–º \"{existing_club.name}\"\n\n"
                    f"üîó –ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–ª—É–±: {club_link}"
                )
                return ConversationHandler.END

        # 5. –ü–∞—Ä—Å–∏–Ω–≥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≥—Ä—É–ø–ø–µ
        try:
            group_data = await parser.parse_group_info(chat.id, context.bot)
        except Exception as e:
            logger.error(f"Error parsing group {chat.id}: {e}")
            await message.reply_text(
                "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥—Ä—É–ø–ø–µ\n\n"
                "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:\n"
                "‚ñ™Ô∏è –ì—Ä—É–ø–ø–∞ —è–≤–ª—è–µ—Ç—Å—è —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø–æ–π\n"
                "‚ñ™Ô∏è –£ –±–æ—Ç–∞ –µ—Å—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø—Ä–∞–≤–∞"
            )
            return ConversationHandler.END

        # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ context
        context.user_data['group_data'] = group_data
        context.user_data['creator_telegram_id'] = user.id

        # 6. –ü–æ–∫–∞–∑–∞—Ç—å preview
        return await show_club_preview(update, context, group_data)

    except Exception as e:
        logger.error(f"Error in create_club_from_group: {e}", exc_info=True)
        await update.message.reply_text(
            "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        )
        return ConversationHandler.END


async def show_club_preview(
    update: Update,
    context: ContextTypes.DEFAULT_TYPE,
    group_data: dict
) -> int:
    """
    –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–≤—å—é –±—É–¥—É—â–µ–≥–æ –∫–ª—É–±–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø—ã
    """
    message_text = (
        f"üìã –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª—É–±–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≥—Ä—É–ø–ø—ã \"{group_data['title']}\"\n\n"
        f"–Ø –Ω–∞—à–µ–ª —Å–ª–µ–¥—É—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:\n"
        f"‚ñ™Ô∏è –ù–∞–∑–≤–∞–Ω–∏–µ: {group_data['title']}\n"
        f"‚ñ™Ô∏è –û–ø–∏—Å–∞–Ω–∏–µ: {group_data['description'] or '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}\n"
        f"‚ñ™Ô∏è –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {group_data['member_count']}\n"
    )

    if group_data['username']:
        message_text += f"‚ñ™Ô∏è –ì—Ä—É–ø–ø–∞: @{group_data['username']}\n"

    message_text += "\n–•–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å –∫–ª—É–± —Å —ç—Ç–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏?"

    keyboard = [
        [
            InlineKeyboardButton("‚úÖ –°–æ–∑–¥–∞—Ç—å", callback_data="group_club_confirm"),
            InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data="group_club_cancel")
        ]
    ]

    await update.message.reply_text(
        message_text,
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

    return CONFIRMING_CLUB_CREATION


async def handle_club_confirmation(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—É–±–∞
    """
    query = update.callback_query
    await query.answer()

    if query.data == "group_club_cancel":
        await query.edit_message_text("‚ùå –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª—É–±–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ")
        return ConversationHandler.END

    # –ü–µ—Ä–µ–π—Ç–∏ –∫ –≤—ã–±–æ—Ä—É —Å–ø–æ—Ä—Ç–æ–≤
    from bot.keyboards import get_sports_selection_keyboard

    context.user_data['selected_sports'] = []

    await query.edit_message_text(
        "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥—ã —Å–ø–æ—Ä—Ç–∞ –¥–ª—è –∫–ª—É–±–∞:\n\n"
        "(–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ)",
        reply_markup=get_sports_selection_keyboard([])
    )

    return SELECTING_SPORTS


async def handle_sports_selection(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Ä—Ç–æ–≤
    """
    query = update.callback_query
    await query.answer()

    callback_data = query.data

    if callback_data == "sport_done":
        # –ó–∞–≤–µ—Ä—à–∏—Ç—å –≤—ã–±–æ—Ä —Å–ø–æ—Ä—Ç–æ–≤
        selected = context.user_data.get('selected_sports', [])

        if not selected:
            await query.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–∏–¥ —Å–ø–æ—Ä—Ç–∞", show_alert=True)
            return SELECTING_SPORTS

        # –°–æ–∑–¥–∞—Ç—å –∫–ª—É–±
        return await finalize_club_creation(update, context)

    # –î–æ–±–∞–≤–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å —Å–ø–æ—Ä—Ç
    sport = callback_data.replace("sport_", "")
    selected = context.user_data.get('selected_sports', [])

    if sport in selected:
        selected.remove(sport)
    else:
        selected.append(sport)

    context.user_data['selected_sports'] = selected

    # –û–±–Ω–æ–≤–∏—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    from bot.keyboards import get_sports_selection_keyboard

    await query.edit_message_reply_markup(
        reply_markup=get_sports_selection_keyboard(selected)
    )

    return SELECTING_SPORTS


async def finalize_club_creation(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è - —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª—É–±–∞ –≤ –ë–î
    """
    query = update.callback_query
    await query.answer()

    group_data = context.user_data.get('group_data')
    selected_sports = context.user_data.get('selected_sports', [])
    creator_telegram_id = context.user_data.get('creator_telegram_id')

    try:
        # –ü–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        with UserStorage() as user_storage:
            user = user_storage.get_user_by_telegram_id(creator_telegram_id)
            if not user:
                # –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
                telegram_user = query.from_user
                user = user_storage.get_or_create_user(
                    telegram_id=telegram_user.id,
                    username=telegram_user.username,
                    first_name=telegram_user.first_name,
                    last_name=telegram_user.last_name
                )

        # –°–æ–∑–¥–∞—Ç—å –∫–ª—É–±
        with ClubStorage() as club_storage:
            club = club_storage.create_club_from_telegram_group(
                creator_id=user.id,
                group_data=group_data,
                sports=selected_sports
            )

        # –î–æ–±–∞–≤–∏—Ç—å —Å–æ–∑–¥–∞—Ç–µ–ª—è –∫–∞–∫ ORGANIZER
        with MembershipStorage() as membership_storage:
            membership_storage.add_member_to_club(
                user_id=user.id,
                club_id=club.id,
                role=UserRole.ORGANIZER
            )

        logger.info(f"Club {club.id} created from group {group_data['chat_id']}")

        # –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        await send_club_created_notifications(
            update, context, club, group_data['chat_id']
        )

        return ConversationHandler.END

    except Exception as e:
        logger.error(f"Error creating club: {e}", exc_info=True)
        await query.edit_message_text(
            "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª—É–±–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        )
        return ConversationHandler.END


async def send_club_created_notifications(
    update: Update,
    context: ContextTypes.DEFAULT_TYPE,
    club,
    group_chat_id: int
):
    """
    –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª—É–±–∞
    """
    query = update.callback_query

    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É
    bot_link = f"https://t.me/{settings.bot_username}?start=club_{club.id}"
    webapp_url = f"{settings.app_url}?startapp=club_{club.id}"

    group_message = (
        f"üéâ –ö–ª—É–± —Å–æ–∑–¥–∞–Ω –≤ Ayda Run!\n\n"
        f"–¢–µ–ø–µ—Ä—å \"{club.name}\" –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ Ayda Run!\n\n"
        f"üîó –í—Å—Ç—É–ø–∏—Ç—å –≤ –∫–ª—É–±: {bot_link}\n\n"
        f"–ß—Ç–æ –¥–∞–µ—Ç –≤–∞–º –∫–ª—É–±:\n"
        f"‚úÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫\n"
        f"‚úÖ –£—á–∞—Å—Ç–∏–µ –≤ –∑–∞–±–µ–≥–∞—Ö\n"
        f"‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è\n"
        f"‚úÖ –û–±—â–µ–Ω–∏–µ —Å –±–µ–≥—É–Ω–∞–º–∏"
    )

    from bot.keyboards import get_webapp_button

    await context.bot.send_message(
        chat_id=group_chat_id,
        text=group_message,
        reply_markup=get_webapp_button(webapp_url, f"üöÄ –û—Ç–∫—Ä—ã—Ç—å {club.name}")
    )

    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä—É –≤ –õ–°
    organizer_message = (
        f"‚úÖ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –ö–ª—É–± \"{club.name}\" —Å–æ–∑–¥–∞–Ω.\n\n"
        f"–í—ã –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–º –∫–ª—É–±–∞.\n\n"
        f"üîó –°—Å—ã–ª–∫–∞ –¥–ª—è –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è:\n{bot_link}\n\n"
        f"–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —ç—Ç–æ–π —Å—Å—ã–ª–∫–æ–π –≤ –≥—Ä—É–ø–ø–µ, —á—Ç–æ–±—ã —É—á–∞—Å—Ç–Ω–∏–∫–∏ –º–æ–≥–ª–∏ –≤—Å—Ç—É–ø–∏—Ç—å!"
    )

    await query.edit_message_text(organizer_message)

    # WebApp –∫–Ω–æ–ø–∫–∞
    await context.bot.send_message(
        chat_id=query.from_user.id,
        text="–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–ª—É–±–æ–º:",
        reply_markup=get_webapp_button(webapp_url, f"üöÄ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª—É–±–æ–º")
    )


async def cancel_creation(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û—Ç–º–µ–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—É–±–∞"""
    await update.message.reply_text("‚ùå –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª—É–±–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ")
    return ConversationHandler.END


# ConversationHandler
group_club_creation_handler = ConversationHandler(
    entry_points=[
        CommandHandler("create_club", create_club_from_group)
    ],
    states={
        CONFIRMING_CLUB_CREATION: [
            CallbackQueryHandler(handle_club_confirmation, pattern="^group_club_")
        ],
        SELECTING_SPORTS: [
            CallbackQueryHandler(handle_sports_selection, pattern="^sport_")
        ],
    },
    fallbacks=[
        CommandHandler("cancel", cancel_creation)
    ],
    conversation_timeout=600,  # 10 –º–∏–Ω—É—Ç
    per_chat=False,  # –†–∞–∑–Ω—ã–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —á–∞—Ç–æ–≤
    per_user=True,   # –ù–æ –æ–¥–∏–Ω —Ä–∞–∑–≥–æ–≤–æ—Ä –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
)
```

**–°—Ç–∞—Ç—É—Å:** ‚¨ú –ù–µ –Ω–∞—á–∞—Ç–æ

---

#### Task 2.2: –î–æ–ø–æ–ª–Ω–∏—Ç—å ClubStorage –º–µ—Ç–æ–¥–∞–º–∏

**–§–∞–π–ª:** `storage/club_storage.py` (–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ)

```python
def get_club_by_telegram_chat_id(self, chat_id: int) -> Optional[Club]:
    """
    –ü–æ–ª—É—á–∏—Ç—å –∫–ª—É–± –ø–æ telegram_chat_id

    Args:
        chat_id: Telegram chat ID –≥—Ä—É–ø–ø—ã

    Returns:
        Club –∏–ª–∏ None
    """
    try:
        return self.session.query(Club).filter(
            Club.telegram_chat_id == chat_id
        ).first()
    except Exception as e:
        logger.error(f"Error in get_club_by_telegram_chat_id: {e}")
        return None


def create_club_from_telegram_group(
    self,
    creator_id: str,
    group_data: dict,
    sports: List[str]
) -> Club:
    """
    –°–æ–∑–¥–∞—Ç—å –∫–ª—É–± –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö Telegram –≥—Ä—É–ø–ø—ã

    Args:
        creator_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è-—Å–æ–∑–¥–∞—Ç–µ–ª—è
        group_data: –î–∞–Ω–Ω—ã–µ –∏–∑ TelegramGroupParser
        sports: –í—ã–±—Ä–∞–Ω–Ω—ã–µ –≤–∏–¥—ã —Å–ø–æ—Ä—Ç–∞

    Returns:
        Club: –°–æ–∑–¥–∞–Ω–Ω—ã–π –∫–ª—É–±

    Raises:
        ValueError: –ï—Å–ª–∏ –≥—Ä—É–ø–ø–∞ —É–∂–µ —Å–≤—è–∑–∞–Ω–∞ —Å –∫–ª—É–±–æ–º
    """
    try:
        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≥—Ä—É–ø–ø–∞ –Ω–µ —Å–≤—è–∑–∞–Ω–∞ —Å –¥—Ä—É–≥–∏–º –∫–ª—É–±–æ–º
        existing_club = self.get_club_by_telegram_chat_id(group_data['chat_id'])
        if existing_club:
            raise ValueError(f"–ì—Ä—É–ø–ø–∞ —É–∂–µ —Å–≤—è–∑–∞–Ω–∞ —Å –∫–ª—É–±–æ–º {existing_club.name}")

        import json

        # –°–æ–∑–¥–∞—Ç—å –∫–ª—É–±
        club = Club(
            name=group_data['title'],
            description=group_data.get('description') or '',
            creator_id=creator_id,
            username=group_data.get('username'),
            telegram_chat_id=group_data['chat_id'],
            invite_link=group_data.get('invite_link'),
            photo=group_data.get('photo'),
            city='Almaty',  # TODO: –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –∏–∑ –≥—Ä—É–ø–ø—ã –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        )

        self.session.add(club)
        self.session.commit()
        self.session.refresh(club)

        logger.info(f"Created club {club.id} from Telegram group {group_data['chat_id']}")
        return club

    except ValueError:
        raise
    except Exception as e:
        self.session.rollback()
        logger.error(f"Error in create_club_from_telegram_group: {e}")
        raise
```

**–°—Ç–∞—Ç—É—Å:** ‚¨ú –ù–µ –Ω–∞—á–∞—Ç–æ

---

### üîî –§–ê–ó–ê 3: –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏

#### Task 3.1: –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø—ã

**–§–∞–π–ª:** `bot/validators.py` (–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ)

```python
def validate_group_data(group_data: dict) -> tuple[bool, str]:
    """
    –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø—ã –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –∫–ª—É–±–∞

    –ü—Ä–æ–≤–µ—Ä–∫–∏:
    - –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –ø—É—Å—Ç–æ–µ –∏ –Ω–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ
    - Chat ID –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π
    - –¢–∏–ø —á–∞—Ç–∞ - –≥—Ä—É–ø–ø–∞ –∏–ª–∏ —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø–∞

    Returns:
        (is_valid: bool, error_message: str)
    """
    if not group_data.get('title'):
        return False, "–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"

    if len(group_data['title']) < 3:
        return False, "–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ (–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞)"

    if group_data.get('type') not in ['group', 'supergroup']:
        return False, "–ö–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–∞—Ö –∏ —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø–∞—Ö"

    if not group_data.get('chat_id'):
        return False, "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –≥—Ä—É–ø–ø—ã"

    return True, ""
```

**–°—Ç–∞—Ç—É—Å:** ‚¨ú –ù–µ –Ω–∞—á–∞—Ç–æ

---

### üß™ –§–ê–ó–ê 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

#### Task 4.1: Unit —Ç–µ—Å—Ç—ã

**–§–∞–π–ª:** `tests/test_bot/test_group_integration.py`

```python
"""
Unit tests for Telegram Group Integration
"""

import pytest
from unittest.mock import Mock, AsyncMock, patch
from bot.group_parser import TelegramGroupParser


class TestGroupParser:
    """–¢–µ—Å—Ç—ã –ø–∞—Ä—Å–µ—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≥—Ä—É–ø–ø–µ"""

    @pytest.mark.asyncio
    async def test_parse_group_info(self):
        """–¢–µ—Å—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞ –±–∞–∑–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"""
        # TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å
        pass

    @pytest.mark.asyncio
    async def test_verify_bot_is_admin(self):
        """–¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –±–æ—Ç–∞"""
        # TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å
        pass

    @pytest.mark.asyncio
    async def test_verify_user_is_admin(self):
        """–¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        # TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å
        pass


class TestClubCreationFromGroup:
    """–¢–µ—Å—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—É–±–∞ –∏–∑ –≥—Ä—É–ø–ø—ã"""

    def test_create_club_from_group_success(self):
        """–¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—É–±–∞"""
        # TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å
        pass

    def test_create_club_group_already_linked(self):
        """–¢–µ—Å—Ç –ø–æ–ø—ã—Ç–∫–∏ —Å–æ–∑–¥–∞—Ç—å –∫–ª—É–± –¥–ª—è —É–∂–µ —Å–≤—è–∑–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø—ã"""
        # TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å
        pass


class TestValidation:
    """–¢–µ—Å—Ç—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏"""

    def test_validate_group_data_success(self):
        """–í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
        # TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å
        pass

    def test_validate_group_data_invalid_type(self):
        """–í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ç–∏–ø–∞ —á–∞—Ç–∞"""
        # TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å
        pass
```

**–°—Ç–∞—Ç—É—Å:** ‚¨ú –ù–µ –Ω–∞—á–∞—Ç–æ

---

#### Task 4.2: Integration —Ç–µ—Å—Ç—ã

**–°—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è –º–∞–Ω—É–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**

1. ‚úÖ **Happy path**: –ê–¥–º–∏–Ω –≥—Ä—É–ø–ø—ã —Å–æ–∑–¥–∞–µ—Ç –∫–ª—É–±
   - –î–æ–±–∞–≤–∏—Ç—å –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É –∫–∞–∫ –∞–¥–º–∏–Ω–∞
   - –í—ã–∑–≤–∞—Ç—å `/create_club`
   - –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ
   - –í—ã–±—Ä–∞—Ç—å —Å–ø–æ—Ä—Ç—ã
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–ª—É–± —Å–æ–∑–¥–∞–Ω –≤ –ë–î
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

2. ‚ùå **Edge case**: –ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç—å –≤—Ç–æ—Ä–æ–π –∫–ª—É–± –¥–ª—è —Ç–æ–π –∂–µ –≥—Ä—É–ø–ø—ã
   - –ü–æ–≤—Ç–æ—Ä–Ω–æ –≤—ã–∑–≤–∞—Ç—å `/create_club` –≤ –≥—Ä—É–ø–ø–µ
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ

3. ‚ùå **Error handling**: –ë–æ—Ç –Ω–µ –∞–¥–º–∏–Ω
   - –£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —É –±–æ—Ç–∞
   - –í—ã–∑–≤–∞—Ç—å `/create_club`
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ

4. ‚ùå **Error handling**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–¥–º–∏–Ω
   - –û—Ç –∏–º–µ–Ω–∏ –æ–±—ã—á–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≤—ã–∑–≤–∞—Ç—å `/create_club`
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ

5. ‚ùå **Validation**: –ö–æ–º–∞–Ω–¥–∞ –≤ –õ–°
   - –í—ã–∑–≤–∞—Ç—å `/create_club` –≤ –ª–∏—á–∫–µ –±–æ—Ç–∞
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ

**–°—Ç–∞—Ç—É—Å:** ‚¨ú –ù–µ –Ω–∞—á–∞—Ç–æ

---

### üìö –§–ê–ó–ê 5: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

#### Task 5.1: –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å handler

**–§–∞–π–ª:** `api_server.py` (–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ)

```python
from bot.group_club_creation_handler import group_club_creation_handler

# –í setup_bot():
application.add_handler(group_club_creation_handler)
```

**–°—Ç–∞—Ç—É—Å:** ‚¨ú –ù–µ –Ω–∞—á–∞—Ç–æ

---

#### Task 5.2: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–§–∞–π–ª:** `docs/bot/GROUP_INTEGRATION.md` (–Ω–æ–≤—ã–π)

```markdown
# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram –≥—Ä—É–ø–ø–∞–º–∏

## –û–±–∑–æ—Ä

–ë–æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª—É–±–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö Telegram –≥—Ä—É–ø–ø.

## –ö–æ–º–∞–Ω–¥—ã

### `/create_club` - –°–æ–∑–¥–∞—Ç—å –∫–ª—É–± –∏–∑ –≥—Ä—É–ø–ø—ã

–†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–∞—Ö. –°–æ–∑–¥–∞–µ—Ç –∫–ª—É–± –≤ Ayda Run –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø—ã.

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –≥—Ä—É–ø–ø—ã
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º/—Å–æ–∑–¥–∞—Ç–µ–ª–µ–º –≥—Ä—É–ø–ø—ã
- –ì—Ä—É–ø–ø–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —É–∂–µ —Å–≤—è–∑–∞–Ω–∞ —Å –∫–ª—É–±–æ–º

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –≤—ã–∑—ã–≤–∞–µ—Ç `/create_club` –≤ –≥—Ä—É–ø–ø–µ
2. –ë–æ—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞
3. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç preview –¥–∞–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø—ã
4. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
5. –ü—Ä–æ—Å–∏—Ç –≤—ã–±—Ä–∞—Ç—å –≤–∏–¥—ã —Å–ø–æ—Ä—Ç–∞
6. –°–æ–∑–¥–∞–µ—Ç –∫–ª—É–± –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

## –ü—Ä–∞–≤–∞ –±–æ—Ç–∞

–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:

| –ü—Ä–∞–≤–æ | –ó–∞—á–µ–º –Ω—É–∂–Ω–æ |
|-------|-------------|
| `can_invite_users` | –°–æ–∑–¥–∞–Ω–∏–µ invite links |

## Deep Links

–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—É–±–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è —Å—Å—ã–ª–∫–∏:

- **–ë–æ—Ç deep link**: `https://t.me/{BOT_USERNAME}?start=club_{UUID}`
- **WebApp deep link**: `{WEB_APP_URL}?startapp=club_{UUID}`

## Troubleshooting

### –ë–æ—Ç –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º

–î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å –ø—Ä–∞–≤–æ–º "–ü—Ä–∏–≥–ª–∞—à–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π".

### –ì—Ä—É–ø–ø–∞ —É–∂–µ —Å–≤—è–∑–∞–Ω–∞ —Å –∫–ª—É–±–æ–º

–ö–∞–∂–¥–∞—è –≥—Ä—É–ø–ø–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω–∞ —Ç–æ–ª—å–∫–æ —Å –æ–¥–Ω–∏–º –∫–ª—É–±–æ–º.
```

**–°—Ç–∞—Ç—É—Å:** ‚¨ú –ù–µ –Ω–∞—á–∞—Ç–æ

---

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è (–æ—Ç–ª–æ–∂–µ–Ω–æ)

### üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø—ã (–§–∞–∑–∞ 6)

**–ö–æ–º–∞–Ω–¥–∞:** `/update_club`

–ü–æ–∑–≤–æ–ª–∏—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä—É –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–ª—É–±–∞ –∏–∑ –≥—Ä—É–ø–ø—ã:
- –ù–∞–∑–≤–∞–Ω–∏–µ
- –û–ø–∏—Å–∞–Ω–∏–µ
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- –ê–≤–∞—Ç–∞—Ä

**–°—Ç–∞—Ç—É—Å:** ‚è≥ –û—Ç–ª–æ–∂–µ–Ω–æ

---

### üîî –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –±–æ—Ç–∞ –∏–∑ –≥—Ä—É–ø–ø—ã (–§–∞–∑–∞ 7)

**Webhook:** `my_chat_member`

–ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –±–æ—Ç–∞ –∏–∑ –≥—Ä—É–ø–ø—ã:
- –ü–æ–º–µ—Ç–∏—Ç—å –∫–ª—É–± –∫–∞–∫ "–Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π"
- –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä—É
- –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–≤—è–∑—å –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
- –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–¥—É–º–∞—Ç—å –ª–æ–≥–∏–∫—É –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
- UI –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

**–°—Ç–∞—Ç—É—Å:** ‚è≥ –û—Ç–ª–æ–∂–µ–Ω–æ (—Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ—Ä–∞–±–æ—Ç–∫–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏)

---

## –ò–¥–µ–∏ –¥–ª—è –±—É–¥—É—â–µ–≥–æ

1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤**
   - –ü—Ä–∏ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –≤ Telegram –≥—Ä—É–ø–ø—É ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å –≤ –∫–ª—É–±
   - –¢—Ä–µ–±—É–µ—Ç webhook `chat_member`

2. **–ü—É–±–ª–∏–∫–∞—Ü–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ –≥—Ä—É–ø–ø—É**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö
   - –ö–Ω–æ–ø–∫–∏ "–ò–¥—É" / "–ù–µ –∏–¥—É"

3. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≥—Ä—É–ø–ø—ã**
   - –ö–æ–º–∞–Ω–¥–∞ `/stats` –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–ª—É–±–∞
   - –ê–∫—Ç–∏–≤–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∏ —Ç.–¥.

4. **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã –¥–ª—è –æ–¥–Ω–æ–≥–æ –∫–ª—É–±–∞**
   - –û–¥–∏–Ω –∫–ª—É–± –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ Telegram –≥—Ä—É–ø–ø
   - –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤ –∏–ª–∏ —É—Ä–æ–≤–Ω–µ–π

---

## –ò—Ç–æ–≥–æ–≤—ã–π —á–µ–∫–ª–∏—Å—Ç –∑–∞–¥–∞—á

### ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- [x] –î–æ–±–∞–≤–∏—Ç—å BOT_USERNAME –≤ config.py

### ‚úÖ –§–∞–∑–∞ 1: Group Parser
- [ ] –°–æ–∑–¥–∞—Ç—å bot/group_parser.py
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å TelegramGroupParser –∫–ª–∞—Å—Å
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å parse_group_info()
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å verify_bot_is_admin()
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å verify_user_is_admin()
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å get_group_photo()
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å get_invite_link()

### ‚úÖ –§–∞–∑–∞ 2: Club Creation Handler
- [ ] –°–æ–∑–¥–∞—Ç—å bot/group_club_creation_handler.py
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å create_club_from_group() entry point
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å show_club_preview()
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å handle_club_confirmation()
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å handle_sports_selection()
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å finalize_club_creation()
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å send_club_created_notifications()
- [ ] –°–æ–∑–¥–∞—Ç—å ConversationHandler
- [ ] –î–æ–ø–æ–ª–Ω–∏—Ç—å ClubStorage:
  - [ ] get_club_by_telegram_chat_id()
  - [ ] create_club_from_telegram_group()

### ‚úÖ –§–∞–∑–∞ 3: –í–∞–ª–∏–¥–∞—Ü–∏—è
- [ ] –î–æ–±–∞–≤–∏—Ç—å validate_group_data() –≤ bot/validators.py
- [ ] –î–æ–±–∞–≤–∏—Ç—å custom exceptions (GroupIntegrationError –∏ —Ç.–¥.)

### ‚úÖ –§–∞–∑–∞ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –°–æ–∑–¥–∞—Ç—å tests/test_bot/test_group_integration.py
- [ ] –ù–∞–ø–∏—Å–∞—Ç—å unit —Ç–µ—Å—Ç—ã –¥–ª—è TelegramGroupParser
- [ ] –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è ClubStorage –º–µ—Ç–æ–¥–æ–≤
- [ ] –ü—Ä–æ–≤–µ—Å—Ç–∏ manual testing:
  - [ ] Happy path
  - [ ] –ì—Ä—É–ø–ø–∞ —É–∂–µ —Å–≤—è–∑–∞–Ω–∞
  - [ ] –ë–æ—Ç –Ω–µ –∞–¥–º–∏–Ω
  - [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–¥–º–∏–Ω
  - [ ] –ö–æ–º–∞–Ω–¥–∞ –≤ –õ–°

### ‚úÖ –§–∞–∑–∞ 5: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [ ] –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å handler –≤ api_server.py
- [ ] –°–æ–∑–¥–∞—Ç—å docs/bot/GROUP_INTEGRATION.md
- [ ] –û–±–Ω–æ–≤–∏—Ç—å docs/bot/ONBOARDING.md (–¥–æ–±–∞–≤–∏—Ç—å Flow 4)

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü—Ä–∞–≤–∞ –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø–µ

**–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:**

| –ü—Ä–∞–≤–æ | –ó–∞—á–µ–º –Ω—É–∂–Ω–æ |
|-------|-------------|
| `can_invite_users` | –°–æ–∑–¥–∞–Ω–∏–µ invite links |

### Telegram API –º–µ—Ç–æ–¥—ã

```python
# –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á–∞—Ç–µ
chat = await bot.get_chat(chat_id)

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
member_count = await bot.get_chat_member_count(chat_id)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
member = await bot.get_chat_member(chat_id, user_id)

# –°–æ–∑–¥–∞–Ω–∏–µ invite link
invite_link = await bot.export_chat_invite_link(chat_id)

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞ –≥—Ä—É–ø–ø—ã
chat.photo.big_file_id
```

### Deep Links –≥–µ–Ω–µ—Ä–∞—Ü–∏—è

```python
from config import settings

# –ë–æ—Ç deep link
bot_link = f"https://t.me/{settings.bot_username}?start=club_{club_id}"

# WebApp deep link
webapp_link = f"{settings.app_url}?startapp=club_{club_id}"
```

### –°–≤—è–∑—å Club ‚Üî Telegram Group

**–í –º–æ–¥–µ–ª–∏ Club —É–∂–µ –µ—Å—Ç—å:**
```python
telegram_chat_id = Column(Integer, nullable=True)  # Telegram chat ID –≥—Ä—É–ø–ø—ã
invite_link = Column(String(500), nullable=True)   # Invite link –≥—Ä—É–ø–ø—ã
username = Column(String(255), nullable=True)      # @groupname (–±–µ–∑ @)
photo = Column(String(255), nullable=True)         # Avatar file_id
```

---

## –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

```mermaid
sequenceDiagram
    participant U as –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä
    participant TG as Telegram Group
    participant B as Bot
    participant DB as Database
    participant APP as Ayda Run App

    U->>TG: /create_club
    TG->>B: Command received

    B->>TG: –ü—Ä–æ–≤–µ—Ä–∫–∞: –∫–æ–º–∞–Ω–¥–∞ –≤ –≥—Ä—É–ø–ø–µ?
    B->>TG: get_chat_member(user_id) - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ —é–∑–µ—Ä–∞
    TG-->>B: user is admin ‚úÖ

    B->>TG: get_chat_member(bot_id) - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –±–æ—Ç–∞
    TG-->>B: bot is admin ‚úÖ

    B->>DB: get_club_by_telegram_chat_id()
    DB-->>B: null (–≥—Ä—É–ø–ø–∞ –Ω–µ —Å–≤—è–∑–∞–Ω–∞)

    B->>TG: get_chat() - –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ
    TG-->>B: chat data

    B->>U: Show preview + confirmation
    U->>B: ‚úÖ Confirm

    B->>U: Select sports
    U->>B: Sports selected

    B->>DB: create_club_from_telegram_group()
    DB-->>B: club created

    B->>DB: add_member(user_id, ORGANIZER)

    B->>TG: Send notification to group
    B->>U: Send notification to user (DM)

    U->>APP: Open club via deep link
```

---

**–°—Ç–∞—Ç—É—Å:** üìã **–ì–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ù–∞—á–∞—Ç—å —Å –§–∞–∑—ã 1 - —Å–æ–∑–¥–∞–Ω–∏–µ TelegramGroupParser
