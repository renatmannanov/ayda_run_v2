# –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –¥–æ—Å—Ç—É–ø–æ–≤ (–æ—Ç–∫—Ä—ã—Ç—ã–µ/–∑–∞–∫—Ä—ã—Ç—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏)

**–î–∞—Ç–∞:** 2025-12-19
**–°—Ç–∞—Ç—É—Å:** –í —Ä–∞–±–æ—Ç–µ

## –¶–µ–ª—å

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∏ –∑–∞–∫—Ä—ã—Ç—ã—Ö –∫–ª—É–±–æ–≤, –≥—Ä—É–ø–ø –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π —Å –º–µ—Ö–∞–Ω–∏–∑–º–æ–º –∑–∞—è–≤–æ–∫ –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ.

---

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –¢–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è
- **–û—Ç–∫—Ä—ã—Ç—ã–µ** —Å—É—â–Ω–æ—Å—Ç–∏ - –≤–∏–¥—è—Ç –í–°–ï, –í–°–ï –º–æ–≥—É—Ç —Å–≤–æ–±–æ–¥–Ω–æ –≤—Å—Ç—É–ø–∏—Ç—å
- **–ó–∞–∫—Ä—ã—Ç—ã–µ** —Å—É—â–Ω–æ—Å—Ç–∏ - –≤–∏–¥—è—Ç –í–°–ï, –Ω–æ –≤—Å—Ç—É–ø–∏—Ç—å –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ –∑–∞—è–≤–∫–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä—É

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

#### 1. –û—Ç–∫—Ä—ã—Ç—ã–µ –∫–ª—É–±—ã/–≥—Ä—É–ø–ø—ã/–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- –í–∏–¥–Ω—ã –í–°–ï–ú –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
- –í–°–ï –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —Å–≤–æ–±–æ–¥–Ω–æ –≤—Å—Ç—É–ø–∏—Ç—å
- –í–∏–¥—è—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ –æ —Å—É—â–Ω–æ—Å—Ç–∏ (—É—á–∞—Å—Ç–Ω–∏–∫–∏, GPX —Ñ–∞–π–ª—ã –∏ —Ç.–¥.)

#### 2. –ó–∞–∫—Ä—ã—Ç—ã–µ –∫–ª—É–±—ã/–≥—Ä—É–ø–ø—ã/–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- –í–∏–¥–Ω—ã –í–°–ï–ú –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (–≤ —Å–ø–∏—Å–∫–∞—Ö, –∫–∞—Ä—Ç–æ—á–∫–∞—Ö)
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏–µ "–∑–∞–∫—Ä—ã—Ç–æ" (üîí)
- –ù–ï –º–æ–≥—É—Ç —Å–≤–æ–±–æ–¥–Ω–æ –≤—Å—Ç—É–ø–∏—Ç—å - —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∑–∞—è–≤–∫—É
- –°–∫—Ä—ã—Ç—ã –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ:
  - –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–≤–∏–¥–Ω–æ —Ç–æ–ª—å–∫–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)
  - GPX —Ñ–∞–π–ª—ã (–Ω–µ–ª—å–∑—è —Å–∫–∞—á–∞—Ç—å)

#### 3. –ú–µ—Ö–∞–Ω–∏–∫–∞ –∑–∞—è–≤–æ–∫ –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ

**–î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
1. –¢—ã–∫–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É"
2. –í–∏–¥–∏—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: "–û—Ç–ø—Ä–∞–≤–∏–º –≤–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä—É?"
3. –ü—Ä–∏ —Å–æ–≥–ª–∞—Å–∏–∏ - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∑–∞—è–≤–∫–∞

**–î–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞:**
1. –ü–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –±–æ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
   - –ò–º—è
   - Username
   - –í—ã–±—Ä–∞–Ω–Ω—ã–µ –≤–∏–¥—ã —Å–ø–æ—Ä—Ç–∞
   - –°—Å—ã–ª–∫–∞ –Ω–∞ Strava (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞)
2. –ö–Ω–æ–ø–∫–∏: "–û–¥–æ–±—Ä–∏—Ç—å" / "–û—Ç–∫–ª–æ–Ω–∏—Ç—å"

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- –ü—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è
- –ü—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç–∫–∞–∑–µ

#### 4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫
- –î–ª—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π: –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —É–∂–µ –ø—Ä–æ—à–ª–∞ - –∑–∞—è–≤–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è
- –î–ª—è –¥—Ä—É–≥–∏—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π: –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ç–∞–π–º–∞—É—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

#### 5. UI –∏–∑–º–µ–Ω–µ–Ω–∏—è
- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç—ã—Ö: "–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è"
- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –∑–∞–∫—Ä—ã—Ç—ã—Ö: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É"
- –ò–∫–æ–Ω–∫–∞ üîí –¥–ª—è –∑–∞–∫—Ä—ã—Ç—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π

---

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–¥–∞

### –ß—Ç–æ –ï–°–¢–¨:
- **Group**: –ø–æ–ª–µ `is_open` (Boolean) - —Ä–∞–±–æ—Ç–∞–µ—Ç
- **Activity**: –ø–æ–ª–µ `visibility` (Enum: PUBLIC, PRIVATE_GROUP, PRIVATE_CLUB, INVITE_ONLY, TELEGRAM_GROUP)
- **Club**: –ù–ï–¢ –ø–æ–ª—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–æ—Å—Ç–∏/–∑–∞–∫—Ä—ã—Ç–æ—Å—Ç–∏
- –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –±–æ—Ç–µ (`bot/admin_notifications.py`)

### –ß—Ç–æ –ù–£–ñ–ù–û –¥–æ–±–∞–≤–∏—Ç—å:
- **Club**: –ø–æ–ª–µ `is_open`
- **Activity**: –ø–æ–ª–µ `is_open` (–æ—Å—Ç–∞–≤–ª—è–µ–º `visibility` –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
- **JoinRequest**: –Ω–æ–≤–∞—è –º–æ–¥–µ–ª—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞—è–≤–æ–∫
- API endpoints –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∑–∞—è–≤–∫–∞–º–∏
- –ë–æ—Ç handlers –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫
- Frontend –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

---

## –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### **–§–∞–∑–∞ 1: –ú–æ–¥–µ–ª–∏ –ë–î –∏ –º–∏–≥—Ä–∞—Ü–∏–∏**

#### 1.1 –û–±–Ω–æ–≤–∏—Ç—å –º–æ–¥–µ–ª—å Club
**–§–∞–π–ª:** `storage/db.py:148`

–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ:
```python
# Access control
is_open = Column(Boolean, default=True, nullable=False)  # True = anyone can join
```

#### 1.2 –û–±–Ω–æ–≤–∏—Ç—å –º–æ–¥–µ–ª—å Activity
**–§–∞–π–ª:** `storage/db.py:290`

–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ (–æ—Å—Ç–∞–≤–ª—è–µ–º `visibility` –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏):
```python
# Access control
is_open = Column(Boolean, default=True, nullable=False)  # True = anyone can join
visibility = Column(...)  # –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
```

#### 1.3 –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å JoinRequest
**–§–∞–π–ª:** `storage/db.py` (–ø–æ—Å–ª–µ –º–æ–¥–µ–ª–∏ Participation)

```python
class JoinRequestStatus(str, Enum):
    """Join request status"""
    PENDING = "pending"
    APPROVED = "approved"
    REJECTED = "rejected"
    EXPIRED = "expired"

class JoinRequest(Base):
    """Join request - user's request to join a closed club/group/activity"""
    __tablename__ = 'join_requests'

    id = Column(String(36), primary_key=True, default=lambda: str(uuid.uuid4()))
    user_id = Column(String(36), ForeignKey('users.id'), nullable=False, index=True)

    # One of these must be set
    club_id = Column(String(36), ForeignKey('clubs.id'), nullable=True, index=True)
    group_id = Column(String(36), ForeignKey('groups.id'), nullable=True, index=True)
    activity_id = Column(String(36), ForeignKey('activities.id'), nullable=True, index=True)

    # Status
    status = Column(SQLEnum(JoinRequestStatus), default=JoinRequestStatus.PENDING, nullable=False)

    # Timestamps
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    expires_at = Column(DateTime, nullable=True)  # Auto-reject after this time

    # Relationships
    user = relationship("User")
    club = relationship("Club")
    group = relationship("Group")
    activity = relationship("Activity")
```

#### 1.4 –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é Alembic
**–ö–æ–º–∞–Ω–¥–∞:** `alembic revision --autogenerate -m "add_access_control_and_join_requests"`

–ú–∏–≥—Ä–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞:
- –î–æ–±–∞–≤–∏—Ç—å `is_open` –∫ Club (default=True)
- –î–æ–±–∞–≤–∏—Ç—å `is_open` –∫ Activity (default=True)
- –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `join_requests`
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `is_open=True` –¥–ª—è –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π

---

### **–§–∞–∑–∞ 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Pydantic —Å—Ö–µ–º**

#### 2.1 –û–±–Ω–æ–≤–∏—Ç—å Club —Å—Ö–µ–º—ã
**–§–∞–π–ª:** `schemas/club.py`

```python
class ClubCreate(BaseModel):
    ...
    is_open: bool = Field(default=True, description="True = anyone can join")

class ClubUpdate(BaseModel):
    ...
    is_open: Optional[bool] = None

class ClubResponse(BaseResponse):
    ...
    is_open: bool
```

#### 2.2 –û–±–Ω–æ–≤–∏—Ç—å Activity —Å—Ö–µ–º—ã
**–§–∞–π–ª:** `schemas/activity.py`

```python
class ActivityCreate(BaseModel):
    ...
    is_open: bool = Field(default=True, description="True = anyone can join")
    # visibility –æ—Å—Ç–∞–µ—Ç—Å—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

class ActivityUpdate(BaseModel):
    ...
    is_open: Optional[bool] = None

class ActivityResponse(BaseResponse):
    ...
    is_open: bool
    # computed fields
    can_view_participants: bool = True  # False if closed and not member
    can_download_gpx: bool = True  # False if closed and not member
```

#### 2.3 –°–æ–∑–¥–∞—Ç—å —Å—Ö–µ–º—ã –¥–ª—è JoinRequest
**–§–∞–π–ª:** `schemas/join_request.py` (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)

```python
from pydantic import BaseModel
from datetime import datetime
from typing import Optional
from .common import BaseResponse

class JoinRequestCreate(BaseModel):
    """Schema for creating join request"""
    # entity_id –±—É–¥–µ—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ URL

class JoinRequestResponse(BaseResponse):
    """Schema for join request response"""
    user_id: str
    club_id: Optional[str]
    group_id: Optional[str]
    activity_id: Optional[str]
    status: str  # pending, approved, rejected, expired
    expires_at: Optional[datetime]

    # User info (–¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞)
    user_name: Optional[str]
    username: Optional[str]
    user_sports: Optional[str]
    user_strava_link: Optional[str]

class JoinRequestAction(BaseModel):
    """Schema for approving/rejecting join request"""
    # action –±—É–¥–µ—Ç –≤ URL (approve/reject)
```

#### 2.4 –û–±–Ω–æ–≤–∏—Ç—å common.py
**–§–∞–π–ª:** `schemas/common.py`

–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–º–ø–æ—Ä—Ç—ã:
```python
from storage.db import JoinRequestStatus
```

---

### **–§–∞–∑–∞ 3: Storage —Å–ª–æ–π**

#### 3.1 –°–æ–∑–¥–∞—Ç—å join_request_storage.py
**–§–∞–π–ª:** `storage/join_request_storage.py` (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)

```python
class JoinRequestStorage:
    """Storage layer for join requests"""

    def create_join_request(self, user_id: str, entity_type: str, entity_id: str) -> JoinRequest
    def get_join_request(self, request_id: str) -> Optional[JoinRequest]
    def get_user_pending_request(self, user_id: str, entity_type: str, entity_id: str) -> Optional[JoinRequest]
    def get_pending_requests_for_entity(self, entity_type: str, entity_id: str) -> List[JoinRequest]
    def update_request_status(self, request_id: str, status: JoinRequestStatus) -> JoinRequest
    def delete_expired_requests(self) -> int
    def set_expiry_for_past_activities(self) -> int
```

---

### **–§–∞–∑–∞ 4: API endpoints**

#### 4.1 –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ join endpoints

**Clubs** (`app/routers/clubs.py:194`):
```python
@router.post("/{club_id}/join", status_code=201)
def join_club(...):
    club = db.query(Club).filter(Club.id == club_id).first()
    if not club:
        raise HTTPException(status_code=404, detail="Club not found")

    # NEW: Check if open
    if not club.is_open:
        raise HTTPException(
            status_code=403,
            detail="This club is closed. Please send a join request instead."
        )

    # existing logic...
```

**Groups** (`app/routers/groups.py:211`):
- –£–∂–µ –µ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∞ `is_open` - –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å

**Activities** (`app/routers/activities.py:271`):
```python
@router.post("/{activity_id}/join", status_code=201)
async def join_activity(...):
    activity = db.query(Activity).filter(Activity.id == activity_id).first()
    if not activity:
        raise HTTPException(status_code=404, detail="Activity not found")

    # NEW: Check if open
    if not activity.is_open:
        raise HTTPException(
            status_code=403,
            detail="This activity is closed. Please send a join request instead."
        )

    # existing logic...
```

#### 4.2 –î–æ–±–∞–≤–∏—Ç—å endpoints –¥–ª—è –∑–∞—è–≤–æ–∫

**–î–ª—è –∫–ª—É–±–æ–≤** (`app/routers/clubs.py`):
```python
@router.post("/{club_id}/request-join", status_code=201)
def request_join_club(...)

@router.get("/{club_id}/join-requests", response_model=List[JoinRequestResponse])
def get_club_join_requests(...)  # —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–≤

@router.post("/{club_id}/join-requests/{request_id}/approve", status_code=200)
def approve_join_request(...)

@router.post("/{club_id}/join-requests/{request_id}/reject", status_code=200)
def reject_join_request(...)
```

**–î–ª—è –≥—Ä—É–ø–ø** (`app/routers/groups.py`):
```python
@router.post("/{group_id}/request-join", status_code=201)
@router.get("/{group_id}/join-requests", response_model=List[JoinRequestResponse])
@router.post("/{group_id}/join-requests/{request_id}/approve", status_code=200)
@router.post("/{group_id}/join-requests/{request_id}/reject", status_code=200)
```

**–î–ª—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π** (`app/routers/activities.py`):
```python
@router.post("/{activity_id}/request-join", status_code=201)
@router.get("/{activity_id}/join-requests", response_model=List[JoinRequestResponse])
@router.post("/{activity_id}/join-requests/{request_id}/approve", status_code=200)
@router.post("/{activity_id}/join-requests/{request_id}/reject", status_code=200)
```

#### 4.3 –°–∫—Ä—ã—Ç–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞–∫—Ä—ã—Ç—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π

**Participants endpoint** (`app/routers/activities.py:337`):
```python
@router.get("/{activity_id}/participants", response_model=List[ParticipantResponse])
async def get_participants(activity_id: str, current_user: Optional[User] = Depends(get_current_user_optional), ...):
    activity = db.query(Activity).filter(Activity.id == activity_id).first()

    # NEW: Check if closed and user is not member
    if not activity.is_open and current_user:
        # Check membership in club/group
        is_member = check_user_membership(db, current_user.id, activity)
        if not is_member:
            # Return only count
            count = db.query(Participation).filter(...).count()
            raise HTTPException(
                status_code=403,
                detail=f"This activity is closed. Participants count: {count}"
            )

    # existing logic...
```

**Members endpoints** –¥–ª—è –∫–ª—É–±–æ–≤ –∏ –≥—Ä—É–ø–ø - –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ.

**GPX download** (–µ—Å–ª–∏ –µ—Å—Ç—å):
- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `is_open` –∏ —á–ª–µ–Ω—Å—Ç–≤–∞ –ø–µ—Ä–µ–¥ –æ—Ç–¥–∞—á–µ–π —Ñ–∞–π–ª–∞

---

### **–§–∞–∑–∞ 5: –ë–æ—Ç - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**

#### 5.1 –°–æ–∑–¥–∞—Ç—å join_request_notifications.py
**–§–∞–π–ª:** `bot/join_request_notifications.py` (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)

```python
async def notify_organizer_about_join_request(
    bot: Bot,
    request_id: str,
    organizer_telegram_id: int,
    user_data: Dict[str, Any],
    entity_data: Dict[str, Any]
) -> bool:
    """
    –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä—É –æ –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–µ

    user_data: {
        'name': str,
        'username': str,
        'preferred_sports': List[str],
        'strava_link': Optional[str]
    }
    entity_data: {
        'type': 'club' | 'group' | 'activity',
        'name': str,
        'id': str
    }
    """

async def notify_user_about_approval(
    bot: Bot,
    user_telegram_id: int,
    entity_name: str,
    entity_type: str
) -> bool:
    """–£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–± –æ–¥–æ–±—Ä–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏"""

async def notify_user_about_rejection(
    bot: Bot,
    user_telegram_id: int,
    entity_name: str,
    entity_type: str,
    reason: Optional[str] = None
) -> bool:
    """–£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–± –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏"""
```

#### 5.2 –û–±–Ω–æ–≤–∏—Ç—å bot/keyboards.py
```python
def get_join_request_keyboard(request_id: str, entity_type: str) -> InlineKeyboardMarkup:
    """
    –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –æ–¥–æ–±—Ä–µ–Ω–∏—è/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è

    –ö–Ω–æ–ø–∫–∏:
    - ‚úÖ –û–¥–æ–±—Ä–∏—Ç—å
    - ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
    """
```

#### 5.3 –û–±–Ω–æ–≤–∏—Ç—å bot/messages.py
```python
def format_join_request_notification(user_data: Dict, entity_data: Dict) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä—É

    –ü—Ä–∏–º–µ—Ä:
    üîî –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ!

    üìç {entity_type}: {entity_name}

    üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:
    –ò–º—è: {name}
    Username: @{username}
    –í–∏–¥—ã —Å–ø–æ—Ä—Ç–∞: {sports}
    Strava: {strava_link}

    –û–¥–æ–±—Ä–∏—Ç—å –∑–∞—è–≤–∫—É?
    """

def format_approval_notification(entity_name: str, entity_type: str) -> str:
    """–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ–¥–æ–±—Ä–µ–Ω–∏–∏"""

def format_rejection_notification(entity_name: str, entity_type: str) -> str:
    """–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏"""
```

#### 5.4 –°–æ–∑–¥–∞—Ç—å handlers –¥–ª—è callback –∫–Ω–æ–ø–æ–∫
**–§–∞–π–ª:** `bot/join_request_handler.py` (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)

```python
async def handle_join_request_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback –∫–Ω–æ–ø–æ–∫:
    - approve_join_{request_id}
    - reject_join_{request_id}
    """
```

**–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤** `main.py`:
```python
application.add_handler(CallbackQueryHandler(
    handle_join_request_callback,
    pattern="^(approve|reject)_join_"
))
```

---

### **–§–∞–∑–∞ 6: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫**

#### 6.1 –°–æ–∑–¥–∞—Ç—å —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É
**–§–∞–π–ª:** `app/services/auto_reject_service.py` (–Ω–æ–≤—ã–π —Ñ–∞–π–ª)

```python
import asyncio
from datetime import datetime
from storage.join_request_storage import JoinRequestStorage
from storage.db import SessionLocal
from bot.join_request_notifications import notify_user_about_rejection

async def auto_reject_expired_requests(bot: Bot):
    """
    –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫–ª–æ–Ω—è—Ç—å –∑–∞—è–≤–∫–∏ –¥–ª—è:
    1. –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –ø—Ä–æ—à–ª–∏
    2. –ó–∞—è–≤–æ–∫ —Å –∏—Å—Ç–µ–∫—à–∏–º expires_at
    """
    with JoinRequestStorage() as storage:
        # Set expiry for past activities
        expired_count = storage.set_expiry_for_past_activities()

        # Delete expired requests and notify users
        expired_requests = storage.get_expired_requests()
        for request in expired_requests:
            # Update status
            storage.update_request_status(request.id, JoinRequestStatus.EXPIRED)

            # Notify user
            entity_name = get_entity_name(request)
            entity_type = get_entity_type(request)
            await notify_user_about_rejection(
                bot,
                request.user.telegram_id,
                entity_name,
                entity_type,
                reason="–í—Ä–µ–º—è –¥–µ–π—Å—Ç–≤–∏—è –∑–∞—è–≤–∫–∏ –∏—Å—Ç–µ–∫–ª–æ"
            )

async def start_auto_reject_service(bot: Bot):
    """–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ñ–æ–Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å –∞–≤—Ç–æ–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)"""
    while True:
        try:
            await auto_reject_expired_requests(bot)
        except Exception as e:
            logger.error(f"Error in auto_reject_service: {e}")

        await asyncio.sleep(300)  # 5 minutes
```

**–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤** `main.py`:
```python
# Start background tasks
asyncio.create_task(start_auto_reject_service(application.bot))
```

---

### **–§–∞–∑–∞ 7: Frontend –∏–∑–º–µ–Ω–µ–Ω–∏—è**

#### 7.1 –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫

**–í –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –∫–ª—É–±–æ–≤/–≥—Ä—É–ø–ø/–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π:**
```javascript
// –ü—Å–µ–≤–¥–æ–∫–æ–¥
if (entity.is_open) {
    button.text = "–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è"
    button.onClick = () => joinEntity(entity.id)
} else {
    button.text = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É"
    button.onClick = () => requestJoinEntity(entity.id)
}
```

#### 7.2 –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–∫—Ä—ã—Ç–æ—Å—Ç–∏

**–í —Å–ø–∏—Å–∫–∞—Ö –∏ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö:**
```javascript
if (!entity.is_open) {
    showLockIcon() // üîí
    showBadge("–ó–∞–∫—Ä—ã—Ç–æ")
}
```

#### 7.3 –°–∫—Ä—ã—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–∫—Ä—ã—Ç—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π

**–°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:**
```javascript
if (!entity.is_open && !entity.is_member) {
    showParticipantsCount() // "–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: 15"
    hideParticipantsList()
} else {
    showFullParticipantsList()
}
```

**GPX —Ñ–∞–π–ª:**
```javascript
if (!entity.is_open && !entity.is_member) {
    hideGPXDownloadButton()
}
```

#### 7.4 –î–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏

```javascript
async function requestJoinEntity(entityId) {
    const confirmed = await showConfirmDialog({
        title: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É?",
        message: "–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–º –≤–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä—É",
        confirmText: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å",
        cancelText: "–û—Ç–º–µ–Ω–∞"
    })

    if (confirmed) {
        await api.post(`/api/activities/${entityId}/request-join`)
        showSuccess("–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!")
    }
}
```

---

### **–§–∞–∑–∞ 8: –¢–µ—Å—Ç—ã**

#### 8.1 Unit —Ç–µ—Å—Ç—ã

**–§–∞–π–ª:** `tests/test_models/test_join_requests.py`
- –°–æ–∑–¥–∞–Ω–∏–µ JoinRequest
- –í–∞–ª–∏–¥–∞—Ü–∏—è (—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –∏–∑ club_id/group_id/activity_id)
- –°–º–µ–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞

**–§–∞–π–ª:** `tests/test_services/test_join_request_storage.py`
- CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏
- –ü–æ–ª—É—á–µ–Ω–∏–µ pending requests
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å—Ç–µ—á–µ–Ω–∏–µ

#### 8.2 Integration —Ç–µ—Å—Ç—ã

**–§–∞–π–ª:** `tests/test_integration/test_join_request_flow.py`
- –¢–µ—Å—Ç: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞—è–≤–∫—É -> –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –æ–¥–æ–±—Ä—è–µ—Ç -> –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω
- –¢–µ—Å—Ç: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞—è–≤–∫—É -> –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –æ—Ç–∫–ª–æ–Ω—è–µ—Ç -> –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –¥–æ–±–∞–≤–ª–µ–Ω
- –¢–µ—Å—Ç: –∞–≤—Ç–æ–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ—à–µ–¥—à–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- –¢–µ—Å—Ç: –Ω–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—É—é –∑–∞—è–≤–∫—É (–ø–æ–∫–∞ pending)
- –¢–µ—Å—Ç: –∑–∞–∫—Ä—ã—Ç–∞—è —Å—É—â–Ω–æ—Å—Ç—å - —Å–∫—Ä—ã—Ç—ã —É—á–∞—Å—Ç–Ω–∏–∫–∏ –∏ GPX

**–§–∞–π–ª:** `tests/test_api/test_access_control.py`
- –¢–µ—Å—Ç: –æ—Ç–∫—Ä—ã—Ç–∞—è —Å—É—â–Ω–æ—Å—Ç—å - –º–æ–∂–Ω–æ –≤—Å—Ç—É–ø–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é
- –¢–µ—Å—Ç: –∑–∞–∫—Ä—ã—Ç–∞—è —Å—É—â–Ω–æ—Å—Ç—å - –Ω–µ–ª—å–∑—è –≤—Å—Ç—É–ø–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é, –Ω—É–∂–Ω–∞ –∑–∞—è–≤–∫–∞
- –¢–µ—Å—Ç: permissions –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–∏—Å–∫–∞ –∑–∞—è–≤–æ–∫ (—Ç–æ–ª—å–∫–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä—ã)

---

## –û—Ç–¥–µ–ª—å–Ω–∞—è –∑–∞–¥–∞—á–∞: –°—Å—ã–ª–∫–∞ –Ω–∞ Strava

### –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ –≤ User –º–æ–¥–µ–ª—å
**–§–∞–π–ª:** `storage/db.py:88`

```python
class User(Base):
    ...
    # Strava integration
    strava_link = Column(String(500), nullable=True)
```

### –û–±–Ω–æ–≤–∏—Ç—å onboarding
**–§–∞–π–ª:** `bot/onboarding_handler.py`

–î–æ–±–∞–≤–∏—Ç—å —à–∞–≥ –∑–∞–ø—Ä–æ—Å–∞ —Å—Å—ã–ª–∫–∏ –Ω–∞ Strava (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
```python
STRAVA_LINK = 4  # new state

async def ask_strava_link(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ó–∞–ø—Ä–æ—Å–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ Strava (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"""
```

### –û–±–Ω–æ–≤–∏—Ç—å —Å—Ö–µ–º—ã
**–§–∞–π–ª:** `schemas/user.py`

```python
class UserResponse(BaseModel):
    ...
    strava_link: Optional[str]

class UserUpdate(BaseModel):
    ...
    strava_link: Optional[str]
```

### –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
```bash
alembic revision --autogenerate -m "add_strava_link_to_user"
```

---

## –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

1. ‚úÖ –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª –ø–ª–∞–Ω–∞
2. ‚è≥ –§–∞–∑–∞ 1: –ú–æ–¥–µ–ª–∏ –ë–î –∏ –º–∏–≥—Ä–∞—Ü–∏–∏
3. ‚è≥ –§–∞–∑–∞ 2: Pydantic —Å—Ö–µ–º—ã
4. ‚è≥ –§–∞–∑–∞ 3: Storage —Å–ª–æ–π
5. ‚è≥ –§–∞–∑–∞ 4: API endpoints
6. ‚è≥ –§–∞–∑–∞ 5: –ë–æ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
7. ‚è≥ –§–∞–∑–∞ 6: –ê–≤—Ç–æ–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ
8. ‚è≥ –§–∞–∑–∞ 7: Frontend
9. ‚è≥ –§–∞–∑–∞ 8: –¢–µ—Å—Ç—ã
10. ‚è≥ –û—Ç–¥–µ–ª—å–Ω–∞—è –∑–∞–¥–∞—á–∞: Strava

---

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- `visibility` –≤ Activity –æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- `is_open` –±—É–¥–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–º –ø–æ–ª–µ–º –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞
- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- Frontend –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)

---

## –†–∏—Å–∫–∏ –∏ –≤–æ–ø—Ä–æ—Å—ã

1. **–ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**: –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–ª—É–±—ã/–≥—Ä—É–ø–ø—ã/–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å—Ç–∞–Ω—É—Ç –æ—Ç–∫—Ä—ã—Ç—ã–º–∏ (is_open=True) - —ç—Ç–æ –û–ö?
2. **Performance**: –ó–∞–ø—Ä–æ—Å—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ —á–ª–µ–Ω—Å—Ç–≤–∞ –º–æ–≥—É—Ç –∑–∞–º–µ–¥–ª–∏—Ç—å API - –≤–æ–∑–º–æ–∂–Ω–æ, –Ω—É–∂–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
3. **Race conditions**: –ï—Å–ª–∏ –¥–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç –∑–∞—è–≤–∫—É –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ - –Ω—É–∂–Ω–∞ —É–Ω–∏–∫–∞–ª—å–Ω–∞—è constraint

---

**–ê–≤—Ç–æ—Ä:** Claude Sonnet 4.5
**–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2025-12-19
